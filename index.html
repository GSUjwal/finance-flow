<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FinanceFlow Pro by GrowEase - Advanced Personal Finance Manager</title>
    <meta name="description" content="Professional personal finance management app by GrowEase with advanced features">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FinanceFlow Pro">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmluYW5jZUZsb3cgUHJvIiwic2hvcnRfbmFtZSI6IkZpbmFuY2VGbG93Iiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOWZhZmIiLCJ0aGVtZV9jb2xvciI6IiMxMGI5ODEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJak1UQmlPVGd4SWo0OGNtVmpkQ0IzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWlJSEo0UFNJeE5pSWdabWxzYkQwaUkzWm1abVptWmlJdlBqeDBaWGgwSUhnOUlqWTBJaUI1UFNJMk5DSWdabWxzYkQwaUl6RXdZams0TVNJZ1ptOXVkQzF6YVhwbFBTSTBPQ0lnWm05dWRDMTNaV2xuYUhROUltSnZiR1FpUGpZOEwzUmxlSFErUEhSbGVIUWdlRDBpTmpRaUlIazlJams0SWlCbWFXeHNQU0lqTVRCaU9UZ3hJaUJtYjI1MExYTnBlbVU5SWpJNElpQm1iMjUwTFhkbGFXZG9kRDBpWW05c1pDSStKVHd2ZEdWNGRENDhMM04yWno0PSIsInNpemVzIjoiMTI4eDEyOCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9IiMxMGI5ODEiPjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiByeD0iMTYiIGZpbGw9IiN2ZmZmZmYiLz48dGV4dCB4PSI2NCIgeT0iNjQiIGZpbGw9IiMxMGI5ODEiIGZvbnQtc2l6ZT0iNDgiIGZvbnQtd2VpZ2h0PSJib2xkIj42PC90ZXh0Pjx0ZXh0IHg9IjY0IiB5PSI5OCIgZmlsbD0iIzEwYjk4MSIgZm9udC1zaXplPSIyOCIgZm9udC13ZWlnaHQ9ImJvbGQiPiU8L3RleHQ+PC9zdmc+">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* High DPI display optimizations */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            body {
                font-size: 15px;
                line-height: 1.5;
            }
            
            .text-sm {
                font-size: 13px;
            }
            
            .text-xs {
                font-size: 11px;
            }
            
            /* Sharper borders and shadows */
            .shadow-sm {
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            }
            
            .shadow-lg {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
        }
        
        /* 4K and ultra-high resolution displays */
        @media (-webkit-min-device-pixel-ratio: 3), (min-resolution: 288dpi) {
            body {
                font-size: 16px;
                line-height: 1.6;
            }
            
            .text-lg {
                font-size: 19px;
            }
            
            .text-xl {
                font-size: 21px;
            }
            
            .text-2xl {
                font-size: 26px;
            }
            
            .text-3xl {
                font-size: 32px;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-animation {
            transition: width 1s ease-in-out;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.1);
        }
        
        .notification {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .badge-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .mobile-nav {
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .desktop-sidebar {
                transform: translateX(-100%);
            }
            .mobile-nav.open {
                transform: translateX(0);
            }
        }

        .delete-btn {
            opacity: 0.7;
            transition: all 0.3s ease;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            padding: 6px;
        }

        .delete-btn:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        .item-row:hover .delete-btn {
            opacity: 1;
        }

        .overdue {
            background: linear-gradient(45deg, #fee2e2, #fecaca);
            border-left: 4px solid #ef4444;
        }

        .due-soon {
            background: linear-gradient(45deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Mobile Header -->
    <div class="md:hidden bg-white shadow-sm p-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-green-600">FinanceFlow Pro</h1>
            <p class="text-xs text-gray-500">by GrowEase</p>
        </div>
        <button id="mobileMenuBtn" class="p-2 rounded-lg bg-green-50 text-green-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>

    <div class="flex">
        <!-- Sidebar -->
        <div id="sidebar" class="desktop-sidebar mobile-nav fixed md:relative z-50 w-64 bg-white h-screen shadow-lg overflow-y-auto">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-2xl font-bold text-green-600">FinanceFlow Pro</h1>
                <p class="text-sm text-gray-500 mt-1">Advanced Finance Management</p>
            </div>
            
            <nav class="p-4 space-y-2">
                <button onclick="showSection('dashboard')" class="nav-btn w-full text-left p-3 rounded-lg bg-green-50 text-green-600 font-medium">
                    üìä Dashboard
                </button>
                <button onclick="showSection('budget')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üí∞ Budget Tracker
                </button>
                <button onclick="showSection('goals')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üéØ Goals
                </button>
                <button onclick="showSection('loans')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üè¶ Loan Manager
                </button>
                <button onclick="showSection('analytics')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üìà Analytics
                </button>
                <button onclick="showSection('reports')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üìã Financial Reports
                </button>
                <button onclick="showSection('achievements')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üèÜ Achievements
                </button>
                <button onclick="showSection('export')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    üì§ Export Data
                </button>
                <button onclick="showSection('settings')" class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-50 text-gray-700">
                    ‚öôÔ∏è Settings
                </button>
            </nav>
        </div>

        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-8">
            <!-- Notifications -->
            <div id="notifications" class="fixed top-4 right-4 z-30 space-y-2"></div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section fade-in">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Financial Dashboard</h2>
                    <p class="text-gray-600">Track your financial health at a glance</p>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Total Balance</p>
                                <p id="totalBalance" class="text-2xl font-bold text-green-600">‚Çπ0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                üí∞
                            </div>
                        </div>
                    </div>

                    <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Monthly Income</p>
                                <p id="monthlyIncome" class="text-2xl font-bold text-blue-600">‚Çπ0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                üìà
                            </div>
                        </div>
                    </div>

                    <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Monthly Expenses</p>
                                <p id="monthlyExpenses" class="text-2xl font-bold text-red-500">‚Çπ0</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                üìâ
                            </div>
                        </div>
                    </div>

                    <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Net Worth</p>
                                <p id="netWorth" class="text-2xl font-bold text-purple-600">‚Çπ0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                üíé
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Entry Buttons -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <button onclick="showQuickEntry('income')" class="bg-green-100 hover:bg-green-200 text-green-700 p-4 rounded-xl transition-colors text-center border-2 border-transparent hover:border-green-300">
                        <div class="text-2xl mb-2">üí∞</div>
                        <div class="font-semibold">Add Income</div>
                        <div class="text-sm opacity-75">Salary, bonus, etc.</div>
                    </button>
                    <button onclick="showQuickEntry('expense')" class="bg-red-100 hover:bg-red-200 text-red-700 p-4 rounded-xl transition-colors text-center border-2 border-transparent hover:border-red-300">
                        <div class="text-2xl mb-2">üí∏</div>
                        <div class="font-semibold">Add Expense</div>
                        <div class="text-sm opacity-75">Bills, shopping, etc.</div>
                    </button>
                    <button onclick="showQuickEntry('asset')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 p-4 rounded-xl transition-colors text-center border-2 border-transparent hover:border-blue-300">
                        <div class="text-2xl mb-2">üè†</div>
                        <div class="font-semibold">Add Asset</div>
                        <div class="text-sm opacity-75">Property, investments</div>
                    </button>
                    <button onclick="showQuickEntry('liability')" class="bg-orange-100 hover:bg-orange-200 text-orange-700 p-4 rounded-xl transition-colors text-center border-2 border-transparent hover:border-orange-300">
                        <div class="text-2xl mb-2">üí≥</div>
                        <div class="font-semibold">Add Liability</div>
                        <div class="text-sm opacity-75">Loans, credit cards</div>
                    </button>
                </div>

                <!-- Enhanced Transaction Form -->
                <div id="transactionForm" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 id="formTitle" class="text-xl font-semibold text-gray-800">Add Transaction</h3>
                            <p id="formSubtitle" class="text-sm text-gray-600 mt-1">Enter your transaction details below</p>
                        </div>
                        <button onclick="hideTransactionForm()" class="text-gray-400 hover:text-gray-600 p-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Transaction Type (Hidden but tracked) -->
                        <input type="hidden" id="transactionType" value="">
                        
                        <!-- Amount Section -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="flex items-center">
                                    <span id="amountIcon" class="text-lg mr-2">üí∞</span>
                                    Amount *
                                </span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">‚Çπ</span>
                                <input type="number" id="transactionAmount" placeholder="0" 
                                       class="w-full pl-8 pr-4 py-3 text-lg border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                       step="0.01" min="0">
                            </div>
                        </div>

                        <!-- Description Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Description *
                            </label>
                            <input type="text" id="transactionDescription" placeholder="What is this transaction for?" 
                                   class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <div class="mt-2">
                                <div class="text-xs text-gray-500 mb-2">Quick suggestions:</div>
                                <div id="quickSuggestions" class="flex flex-wrap gap-2">
                                    <!-- Suggestions will be populated based on transaction type -->
                                </div>
                            </div>
                        </div>

                        <!-- Category Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Category *
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="categoryGrid">
                                <!-- Categories will be populated based on transaction type -->
                            </div>
                            <select id="transactionCategory" class="hidden">
                                <!-- Hidden select for form compatibility -->
                            </select>
                        </div>

                        <!-- Date Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Date
                                </label>
                                <input type="date" id="transactionDate" 
                                       class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Payment Method
                                </label>
                                <select id="paymentMethod" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="cash">Cash</option>
                                    <option value="bank">Bank Transfer</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Additional Notes (Optional)
                            </label>
                            <textarea id="transactionNotes" placeholder="Any additional details..." 
                                      class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                                      rows="2"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                            <button onclick="hideTransactionForm()" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Cancel
                            </button>
                            <button onclick="addTransaction()" id="submitButton" class="bg-green-600 text-white px-8 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                Add Transaction
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Recent Transactions</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="exportTransactionsToPDF()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                                üìÑ PDF
                            </button>
                            <button onclick="exportTransactionsToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                                üìä Excel
                            </button>
                            <button onclick="clearAllTransactions()" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                Clear All
                            </button>
                        </div>
                    </div>
                    <div id="transactionsList" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction above!</p>
                    </div>
                </div>
            </div>

            <!-- Budget Tracker Section -->
            <div id="budget" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Budget Tracker</h2>
                    <p class="text-gray-600">Monitor your spending across different categories</p>
                </div>

                <!-- Add Budget Category -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Set Budget</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="budgetCategory" placeholder="Category (e.g., Food, Transport)" class="p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <input type="number" id="budgetAmount" placeholder="Budget Amount (‚Çπ)" class="p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <button onclick="addBudget()" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            Set Budget
                        </button>
                    </div>
                </div>

                <!-- Budget Categories -->
                <div id="budgetCategories" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                        <p class="text-gray-500">No budgets set yet. Create your first budget above!</p>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div id="goals" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Financial Goals</h2>
                    <p class="text-gray-600">Set and track your savings goals</p>
                </div>

                <!-- Add Goal -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Create New Goal</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="goalName" placeholder="Goal Name (e.g., Laptop)" class="p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <input type="number" id="goalTarget" placeholder="Target Amount (‚Çπ)" class="p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <input type="date" id="goalDeadline" class="p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <button onclick="addGoal()" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            Create Goal
                        </button>
                    </div>
                </div>

                <!-- Goals List -->
                <div id="goalsList" class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                        <p class="text-gray-500">No goals set yet. Create your first goal above!</p>
                    </div>
                </div>
            </div>

            <!-- Loans Section -->
            <div id="loans" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Loan Manager</h2>
                    <p class="text-gray-600">Professional double-entry loan management with automatic accounting</p>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <button onclick="showLoanAction('disburse')" class="bg-green-600 text-white p-4 rounded-xl hover:bg-green-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üí∏</div>
                        <div class="font-semibold">Disburse Loan</div>
                        <div class="text-sm opacity-90">Give money to borrower</div>
                    </button>
                    <button onclick="showLoanAction('receive')" class="bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üí∞</div>
                        <div class="font-semibold">Receive Loan</div>
                        <div class="text-sm opacity-90">Take money from lender</div>
                    </button>
                    <button onclick="showLoanAction('repayment')" class="bg-purple-600 text-white p-4 rounded-xl hover:bg-purple-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üìà</div>
                        <div class="font-semibold">Receive Repayment</div>
                        <div class="text-sm opacity-90">Get money back from borrower</div>
                    </button>
                    <button onclick="showLoanAction('repay')" class="bg-orange-600 text-white p-4 rounded-xl hover:bg-orange-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üìâ</div>
                        <div class="font-semibold">Repay Loan</div>
                        <div class="text-sm opacity-90">Pay money back to lender</div>
                    </button>
                </div>

                <!-- Loan Action Form -->
                <div id="loanActionForm" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="loanActionTitle" class="text-xl font-semibold text-gray-800"></h3>
                        <button onclick="hideLoanAction()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact</label>
                            <select id="loanContact" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Select or add new contact</option>
                            </select>
                            <input type="text" id="newContactName" placeholder="Or enter new contact name" class="w-full p-2 border border-gray-200 rounded-lg mt-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Principal Amount (‚Çπ)</label>
                            <input type="number" id="loanActionAmount" placeholder="Enter principal amount" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                            <select id="loanAccount" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="cash">Cash in Hand</option>
                                <option value="bank">Bank Account</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (% p.a.)</label>
                            <input type="number" id="loanInterestRate" placeholder="0" step="0.1" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Given/Received Date</label>
                            <input type="date" id="loanActionGivenDate" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                            <input type="date" id="loanActionDueDate" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tenure (Months)</label>
                            <input type="number" id="loanTenure" placeholder="12" min="1" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea id="loanActionNotes" placeholder="Add any additional notes..." class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" rows="2"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="hideLoanAction()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Cancel
                        </button>
                        <button onclick="processLoanAction()" id="loanActionButton" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            Process Transaction
                        </button>
                    </div>
                </div>

                <!-- Account Balances -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üíµ Cash in Hand</h3>
                        <p id="cashBalance" class="text-2xl font-bold text-green-600">‚Çπ0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üè¶ Bank Account</h3>
                        <p id="bankBalance" class="text-2xl font-bold text-blue-600">‚Çπ0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üìà Loans Given</h3>
                        <p id="loansGivenBalance" class="text-2xl font-bold text-purple-600">‚Çπ0</p>
                        <p class="text-sm text-gray-500">Money owed to you</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üìâ Loans Taken</h3>
                        <p id="loansTakenBalance" class="text-2xl font-bold text-red-600">‚Çπ0</p>
                        <p class="text-sm text-gray-500">Money you owe</p>
                    </div>
                </div>

                <!-- Active Loans -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Active Loans</h3>
                        <div class="flex space-x-2">
                            <button onclick="showContacts()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition-colors">
                                üë• Manage Contacts
                            </button>
                            <button onclick="clearAllLoans()" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                Clear All
                            </button>
                        </div>
                    </div>
                    <div id="activeLoansDisplay" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No active loans. Use the buttons above to start managing loans!</p>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Loan Transactions</h3>
                    <div id="recentLoanTransactions" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">No loan transactions yet.</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Financial Analytics</h2>
                    <p class="text-gray-600">Visual insights into your financial patterns</p>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Income vs Expenses Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Income vs Expenses</h3>
                        <canvas id="incomeExpenseChart" width="400" height="300"></canvas>
                    </div>

                    <!-- Category Breakdown -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Expense Categories</h3>
                        <canvas id="categoryChart" width="400" height="300"></canvas>
                    </div>

                    <!-- Monthly Trend -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Monthly Financial Trend</h3>
                        <canvas id="trendChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Financial Reports</h2>
                    <p class="text-gray-600">Professional financial statements and analysis</p>
                </div>

                <!-- Report Tabs -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-8">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6">
                            <button onclick="showReport('balance-sheet')" class="report-tab py-4 px-2 border-b-2 border-green-500 text-green-600 font-medium">
                                Balance Sheet
                            </button>
                            <button onclick="showReport('income-statement')" class="report-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                Income Statement
                            </button>
                            <button onclick="showReport('cash-flow')" class="report-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                Cash Flow
                            </button>
                        </nav>
                    </div>

                    <!-- Balance Sheet -->
                    <div id="balance-sheet" class="report-content p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Balance Sheet</h3>
                            <div class="text-sm text-gray-500">
                                As of <span id="balanceSheetDate"></span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                                <h4 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
                                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                    Assets
                                </h4>
                                <div id="assetsList" class="space-y-2">
                                    <!-- Assets will be populated by JavaScript -->
                                </div>
                                <div class="border-t-2 border-green-300 pt-4 mt-4">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>Total Assets:</span>
                                        <span id="totalAssets" class="text-green-700">‚Çπ0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl border border-red-200">
                                <h4 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
                                    <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                    Liabilities & Equity
                                </h4>
                                <div id="liabilitiesList" class="space-y-2">
                                    <!-- Liabilities will be populated by JavaScript -->
                                </div>
                                <div class="border-t-2 border-red-300 pt-4 mt-4">
                                    <div class="flex justify-between font-semibold">
                                        <span>Total Liabilities:</span>
                                        <span id="totalLiabilities" class="text-red-700">‚Çπ0</span>
                                    </div>
                                </div>
                                <div class="border-t-2 border-blue-300 pt-4 mt-4 bg-blue-50 -mx-6 px-6 pb-6 rounded-b-xl">
                                    <div class="flex justify-between font-bold text-xl">
                                        <span>Net Worth (Equity):</span>
                                        <span id="balanceSheetNetWorth" class="text-blue-700">‚Çπ0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Analysis Section -->
                        <div id="financialAnalysis" class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-xl border border-purple-200">
                            <h4 class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                                <span class="text-2xl mr-2">üîç</span>
                                Financial Health Analysis
                            </h4>
                            <div id="analysisContent" class="space-y-4">
                                <!-- Analysis content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Income Statement -->
                    <div id="income-statement" class="report-content p-6 hidden">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6">Income Statement</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-medium">Total Revenue:</span>
                                <span id="totalRevenue" class="text-green-600 font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-medium">Total Expenses:</span>
                                <span id="totalExpensesReport" class="text-red-600 font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-400">
                                <span class="font-bold text-lg">Net Income:</span>
                                <span id="netIncome" class="font-bold text-lg">‚Çπ0</span>
                            </div>
                            <div class="mt-6">
                                <h4 class="text-lg font-medium text-gray-700 mb-4">Expense Breakdown</h4>
                                <div id="expenseBreakdown" class="space-y-2">
                                    <!-- Expense breakdown will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow -->
                    <div id="cash-flow" class="report-content p-6 hidden">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6">Cash Flow Statement</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-medium text-gray-700 mb-4">Operating Activities</h4>
                                <div class="space-y-2 ml-4">
                                    <div class="flex justify-between">
                                        <span>Cash from Income:</span>
                                        <span id="cashFromIncome" class="text-green-600">‚Çπ0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Cash for Expenses:</span>
                                        <span id="cashForExpenses" class="text-red-600">‚Çπ0</span>
                                    </div>
                                    <div class="flex justify-between font-semibold border-t pt-2">
                                        <span>Net Operating Cash Flow:</span>
                                        <span id="netOperatingCashFlow">‚Çπ0</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium text-gray-700 mb-4">Financing Activities</h4>
                                <div class="space-y-2 ml-4">
                                    <div class="flex justify-between">
                                        <span>Loans Received:</span>
                                        <span id="cashFromLoans" class="text-green-600">‚Çπ0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Loans Given:</span>
                                        <span id="cashForLoans" class="text-red-600">‚Çπ0</span>
                                    </div>
                                    <div class="flex justify-between font-semibold border-t pt-2">
                                        <span>Net Financing Cash Flow:</span>
                                        <span id="netFinancingCashFlow">‚Çπ0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t pt-4">
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Net Cash Flow:</span>
                                    <span id="netCashFlow">‚Çπ0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div id="achievements" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Achievements</h2>
                    <p class="text-gray-600">Your financial milestones and badges</p>
                </div>

                <!-- Current Streak -->
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-xl text-white mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Current Streak</h3>
                            <p id="currentStreak" class="text-3xl font-bold">0 days</p>
                            <p class="text-green-100">Keep tracking your finances!</p>
                        </div>
                        <div class="text-6xl">üî•</div>
                    </div>
                </div>

                <!-- Badges -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Achievement Badges</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="badgesList">
                        <!-- Badges will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div id="export" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Export Data</h2>
                    <p class="text-gray-600">Download your financial data and reports</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìÑ Export to PDF</h3>
                        <p class="text-gray-600 mb-4">Generate comprehensive financial reports</p>
                        <div class="space-y-2">
                            <button onclick="exportToPDF('complete')" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                                Complete Financial Report
                            </button>
                            <button onclick="exportToPDF('balance-sheet')" class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition-colors font-medium">
                                Balance Sheet Only
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Export to Excel</h3>
                        <p class="text-gray-600 mb-4">Download data as spreadsheets</p>
                        <div class="space-y-2">
                            <button onclick="exportToExcel('all')" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                All Data (Multiple Sheets)
                            </button>
                            <button onclick="exportToExcel('transactions')" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                Transactions Only
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Settings</h2>
                    <p class="text-gray-600">Customize your FinanceFlow Pro experience</p>
                </div>

                <div class="space-y-6">
                    <!-- Notification Settings -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üîî Notification Settings</h3>
                        <div class="space-y-4">
                            <label class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-gray-700">Enable Notifications</span>
                                    <p class="text-sm text-gray-500">Receive alerts for loan payments and reminders</p>
                                </div>
                                <input type="checkbox" id="enableNotifications" class="rounded border-gray-300 text-green-600 focus:ring-green-500" checked>
                            </label>
                            
                            <label class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-gray-700">Notification Sound</span>
                                    <p class="text-sm text-gray-500">Play sound when notifications appear</p>
                                </div>
                                <input type="checkbox" id="notificationSound" class="rounded border-gray-300 text-green-600 focus:ring-green-500" checked>
                            </label>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üíæ Data Management</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Sample Data</h4>
                                <div class="flex space-x-2 mb-4">
                                    <button onclick="loadSampleDataManually()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                        üéØ Load Sample Data
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500">Load realistic examples to explore all features</p>
                            </div>
                            
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Backup & Restore</h4>
                                <div class="flex space-x-2">
                                    <button onclick="backupData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                        üì• Backup Data
                                    </button>
                                    <button onclick="document.getElementById('restoreFile').click()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                        üì§ Restore Data
                                    </button>
                                    <input type="file" id="restoreFile" accept=".json" class="hidden" onchange="restoreData(event)">
                                </div>
                            </div>
                            
                            <div class="border-t pt-4">
                                <h4 class="font-medium text-red-600 mb-2">‚ö†Ô∏è Danger Zone</h4>
                                <button onclick="clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    üóëÔ∏è Clear All Data
                                </button>
                                <p class="text-sm text-gray-500 mt-1">This will permanently delete all your financial data</p>
                            </div>
                        </div>
                    </div>

                    <!-- App Information -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">‚ÑπÔ∏è App Information</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Version:</span>
                                <span class="font-medium">2.0.0 Pro</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Transactions:</span>
                                <span class="font-medium" id="totalTransactionsCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Active Loans:</span>
                                <span class="font-medium" id="activeLoansCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Data Size:</span>
                                <span class="font-medium" id="dataSize">0 KB</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Data Storage with Double-Entry Accounting
        let financeData = {
            transactions: [],
            budgets: [],
            goals: [],
            loans: [],
            accounts: [
                // Default Chart of Accounts - Professional CA Structure (All Zero Balances)
                { id: 'cash', name: 'Cash in Hand', type: 'asset', balance: 0, category: 'current' },
                { id: 'bank', name: 'Bank Account', type: 'asset', balance: 0, category: 'current' },
                { id: 'loan_receivable', name: 'Loans & Advances (Receivable)', type: 'asset', balance: 0, category: 'current' },
                { id: 'loan_payable', name: 'Loans & Borrowings (Payable)', type: 'liability', balance: 0, category: 'current' },
                { id: 'interest_receivable', name: 'Interest Receivable', type: 'asset', balance: 0, category: 'current' },
                { id: 'interest_payable', name: 'Interest Payable', type: 'liability', balance: 0, category: 'current' },
                { id: 'income', name: 'Income Account', type: 'income', balance: 0, category: 'revenue' },
                { id: 'interest_income', name: 'Interest Income', type: 'income', balance: 0, category: 'revenue' },
                { id: 'expenses', name: 'Expense Account', type: 'expense', balance: 0, category: 'operating' },
                { id: 'interest_expense', name: 'Interest Expense', type: 'expense', balance: 0, category: 'operating' }
            ],
            contacts: [],
            journalEntries: [],
            achievements: [],
            streak: 0,
            lastActivity: null,
            notifications: [],
            settings: {
                enableNotifications: true,
                notificationSound: true
            }
        };

        // Load data from localStorage
        function loadData() {
            try {
                const saved = localStorage.getItem('financeFlowProData');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    // Validate data structure
                    if (parsedData && typeof parsedData === 'object') {
                        financeData = {
                            transactions: parsedData.transactions || [],
                            budgets: parsedData.budgets || [],
                            goals: parsedData.goals || [],
                            loans: parsedData.loans || [],
                            accounts: parsedData.accounts || [
                                { id: 'cash', name: 'Cash in Hand', type: 'asset', balance: 0, category: 'current' },
                                { id: 'bank', name: 'Bank Account', type: 'asset', balance: 0, category: 'current' },
                                { id: 'loan_receivable', name: 'Loans Given (Receivable)', type: 'asset', balance: 0, category: 'current' },
                                { id: 'loan_payable', name: 'Loans Taken (Payable)', type: 'liability', balance: 0, category: 'current' },
                                { id: 'income', name: 'Income Account', type: 'income', balance: 0, category: 'revenue' },
                                { id: 'expenses', name: 'Expense Account', type: 'expense', balance: 0, category: 'operating' }
                            ],
                            contacts: parsedData.contacts || [],
                            journalEntries: parsedData.journalEntries || [],
                            achievements: parsedData.achievements || [],
                            streak: parsedData.streak || 0,
                            lastActivity: parsedData.lastActivity || null,
                            notifications: parsedData.notifications || [],
                            settings: parsedData.settings || {
                                enableNotifications: true,
                                notificationSound: true
                            }
                        };
                    }
                }
                
                updateDashboard();
                updateBudgetDisplay();
                updateGoalsDisplay();
                updateLoansDisplay();
                updateReports();
                updateCharts();
                updateAccountBalances();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading saved data. Starting fresh.', 'error');
                // Reset to default data structure
                financeData = {
                    transactions: [],
                    budgets: [],
                    goals: [],
                    loans: [],
                    accounts: [
                        { id: 'cash', name: 'Cash in Hand', type: 'asset', balance: 0, category: 'current' },
                        { id: 'bank', name: 'Bank Account', type: 'asset', balance: 0, category: 'current' },
                        { id: 'loan_receivable', name: 'Loans & Advances (Receivable)', type: 'asset', balance: 0, category: 'current' },
                        { id: 'loan_payable', name: 'Loans & Borrowings (Payable)', type: 'liability', balance: 0, category: 'current' },
                        { id: 'interest_receivable', name: 'Interest Receivable', type: 'asset', balance: 0, category: 'current' },
                        { id: 'interest_payable', name: 'Interest Payable', type: 'liability', balance: 0, category: 'current' },
                        { id: 'income', name: 'Income Account', type: 'income', balance: 0, category: 'revenue' },
                        { id: 'interest_income', name: 'Interest Income', type: 'income', balance: 0, category: 'revenue' },
                        { id: 'expenses', name: 'Expense Account', type: 'expense', balance: 0, category: 'operating' },
                        { id: 'interest_expense', name: 'Interest Expense', type: 'expense', balance: 0, category: 'operating' }
                    ],
                    contacts: [],
                    journalEntries: [],
                    notifications: [],
                    settings: {
                        enableNotifications: true,
                        notificationSound: true
                    }
                };
            }
        }

        // Double-Entry Accounting Functions
        function createJournalEntry(description, entries) {
            const journalEntry = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date(),
                description: description,
                entries: entries,
                reference: `JE${Date.now()}`
            };

            // Validate double-entry (debits must equal credits)
            const totalDebits = entries.filter(e => e.type === 'debit').reduce((sum, e) => sum + e.amount, 0);
            const totalCredits = entries.filter(e => e.type === 'credit').reduce((sum, e) => sum + e.amount, 0);

            if (Math.abs(totalDebits - totalCredits) > 0.01) {
                throw new Error('Journal entry is not balanced. Debits must equal credits.');
            }

            // Update account balances
            entries.forEach(entry => {
                const account = financeData.accounts.find(acc => acc.id === entry.accountId);
                if (account) {
                    if (entry.type === 'debit') {
                        if (account.type === 'asset' || account.type === 'expense') {
                            account.balance += entry.amount;
                        } else {
                            account.balance -= entry.amount;
                        }
                    } else { // credit
                        if (account.type === 'asset' || account.type === 'expense') {
                            account.balance -= entry.amount;
                        } else {
                            account.balance += entry.amount;
                        }
                    }
                }
            });

            financeData.journalEntries.push(journalEntry);
            return journalEntry;
        }

        // Loan Action Functions
        let currentLoanAction = null;

        function showLoanAction(action) {
            currentLoanAction = action;
            const form = document.getElementById('loanActionForm');
            const title = document.getElementById('loanActionTitle');
            const button = document.getElementById('loanActionButton');
            
            form.classList.remove('hidden');
            
            // Update form based on action
            switch(action) {
                case 'disburse':
                    title.textContent = 'üí∏ Disburse Loan';
                    button.textContent = 'Disburse Loan';
                    button.className = 'bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium';
                    break;
                case 'receive':
                    title.textContent = 'üí∞ Receive Loan';
                    button.textContent = 'Receive Loan';
                    button.className = 'bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium';
                    break;
                case 'repayment':
                    title.textContent = 'üìà Receive Repayment';
                    button.textContent = 'Record Repayment';
                    button.className = 'bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium';
                    break;
                case 'repay':
                    title.textContent = 'üìâ Repay Loan';
                    button.textContent = 'Make Payment';
                    button.className = 'bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium';
                    break;
            }
            
            // Set default dates
            const today = new Date();
            const defaultDueDate = new Date();
            defaultDueDate.setMonth(defaultDueDate.getMonth() + 1);
            
            document.getElementById('loanActionGivenDate').value = today.toISOString().split('T')[0];
            document.getElementById('loanActionDueDate').value = defaultDueDate.toISOString().split('T')[0];
            document.getElementById('loanTenure').value = '12';
            
            // Populate contacts
            updateContactDropdown();
        }

        function hideLoanAction() {
            document.getElementById('loanActionForm').classList.add('hidden');
            clearLoanForm();
        }

        function clearLoanForm() {
            document.getElementById('loanContact').value = '';
            document.getElementById('newContactName').value = '';
            document.getElementById('loanActionAmount').value = '';
            document.getElementById('loanInterestRate').value = '';
            document.getElementById('loanTenure').value = '12';
            document.getElementById('loanActionNotes').value = '';
            
            // Reset dates to defaults
            const today = new Date();
            const defaultDueDate = new Date();
            defaultDueDate.setMonth(defaultDueDate.getMonth() + 1);
            
            document.getElementById('loanActionGivenDate').value = today.toISOString().split('T')[0];
            document.getElementById('loanActionDueDate').value = defaultDueDate.toISOString().split('T')[0];
        }

        function updateContactDropdown() {
            const dropdown = document.getElementById('loanContact');
            dropdown.innerHTML = '<option value="">Select or add new contact</option>';
            
            financeData.contacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.id;
                option.textContent = contact.name;
                dropdown.appendChild(option);
            });
        }

        function processLoanAction() {
            const contactId = document.getElementById('loanContact').value;
            const newContactName = document.getElementById('newContactName').value.trim();
            const amount = parseFloat(document.getElementById('loanActionAmount').value);
            const account = document.getElementById('loanAccount').value;
            const interestRate = parseFloat(document.getElementById('loanInterestRate').value) || 0;
            const givenDate = document.getElementById('loanActionGivenDate').value;
            const dueDate = document.getElementById('loanActionDueDate').value;
            const tenure = parseInt(document.getElementById('loanTenure').value) || 12;
            const notes = document.getElementById('loanActionNotes').value.trim();

            // Validation
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid principal amount', 'error');
                return;
            }

            if (!contactId && !newContactName) {
                showNotification('Please select a contact or enter a new contact name', 'error');
                return;
            }

            if (!givenDate) {
                showNotification('Please select the given/received date', 'error');
                return;
            }

            if (!dueDate) {
                showNotification('Please select a due date', 'error');
                return;
            }

            // Create or get contact
            let contact;
            if (contactId) {
                contact = financeData.contacts.find(c => c.id == contactId);
            } else {
                // Create new contact
                contact = {
                    id: Date.now(),
                    name: newContactName,
                    phone: '',
                    email: '',
                    address: '',
                    created: new Date().toISOString().split('T')[0]
                };
                financeData.contacts.push(contact);
            }

            try {
                // Process the loan action with double-entry accounting
                switch(currentLoanAction) {
                    case 'disburse':
                        disburseLoan(contact, amount, account, interestRate, givenDate, dueDate, tenure, notes);
                        break;
                    case 'receive':
                        receiveLoan(contact, amount, account, interestRate, givenDate, dueDate, tenure, notes);
                        break;
                    case 'repayment':
                        receiveRepayment(contact, amount, account, notes);
                        break;
                    case 'repay':
                        repayLoan(contact, amount, account, notes);
                        break;
                }

                // Update displays
                updateAccountBalances();
                updateLoansDisplay();
                updateReports();
                updateDashboard();
                saveData();
                hideLoanAction();
                
                showNotification(`${currentLoanAction.charAt(0).toUpperCase() + currentLoanAction.slice(1)} processed successfully!`, 'success');
                
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Professional Loan Transaction Functions with CA-level Accounting
        function disburseLoan(contact, amount, fromAccount, interestRate, givenDate, dueDate, tenure, notes) {
            // Check if account has sufficient balance
            const account = financeData.accounts.find(acc => acc.id === fromAccount);
            if (account.balance < amount) {
                throw new Error(`Insufficient balance in ${account.name}. Available: ‚Çπ${account.balance.toLocaleString()}`);
            }

            // Calculate interest amount for the tenure
            const interestAmount = (amount * interestRate * tenure) / (12 * 100);
            const totalAmount = amount + interestAmount;

            // Create journal entry: Dr. Loan Receivable, Cr. Cash/Bank
            const entries = [
                { accountId: 'loan_receivable', type: 'debit', amount: amount },
                { accountId: fromAccount, type: 'credit', amount: amount }
            ];

            // If interest is applicable, record interest receivable
            if (interestAmount > 0) {
                entries.push({ accountId: 'interest_receivable', type: 'debit', amount: interestAmount });
                entries.push({ accountId: 'interest_income', type: 'credit', amount: interestAmount });
            }

            const journalEntry = createJournalEntry(`Loan disbursed to ${contact.name} - Principal: ‚Çπ${amount.toLocaleString()}, Interest: ‚Çπ${interestAmount.toLocaleString()}`, entries);

            // Create professional loan record
            const loan = {
                id: Date.now(),
                contactId: contact.id,
                contactName: contact.name,
                type: 'given',
                principalAmount: amount,
                interestAmount: interestAmount,
                totalAmount: totalAmount,
                currentBalance: totalAmount,
                interestRate: interestRate,
                tenure: tenure,
                givenDate: givenDate,
                dueDate: dueDate,
                status: 'active',
                notes: notes,
                createdDate: new Date().toISOString().split('T')[0],
                journalEntryId: journalEntry.id,
                transactions: [],
                emi: tenure > 1 ? Math.round(totalAmount / tenure) : totalAmount
            };

            financeData.loans.push(loan);
        }

        function receiveLoan(contact, amount, toAccount, interestRate, givenDate, dueDate, tenure, notes) {
            // Calculate interest amount for the tenure
            const interestAmount = (amount * interestRate * tenure) / (12 * 100);
            const totalAmount = amount + interestAmount;

            // Create journal entry: Dr. Cash/Bank, Cr. Loan Payable
            const entries = [
                { accountId: toAccount, type: 'debit', amount: amount },
                { accountId: 'loan_payable', type: 'credit', amount: amount }
            ];

            // If interest is applicable, record interest payable
            if (interestAmount > 0) {
                entries.push({ accountId: 'interest_expense', type: 'debit', amount: interestAmount });
                entries.push({ accountId: 'interest_payable', type: 'credit', amount: interestAmount });
            }

            const journalEntry = createJournalEntry(`Loan received from ${contact.name} - Principal: ‚Çπ${amount.toLocaleString()}, Interest: ‚Çπ${interestAmount.toLocaleString()}`, entries);

            // Create professional loan record
            const loan = {
                id: Date.now(),
                contactId: contact.id,
                contactName: contact.name,
                type: 'received',
                principalAmount: amount,
                interestAmount: interestAmount,
                totalAmount: totalAmount,
                currentBalance: totalAmount,
                interestRate: interestRate,
                tenure: tenure,
                givenDate: givenDate,
                dueDate: dueDate,
                status: 'active',
                notes: notes,
                createdDate: new Date().toISOString().split('T')[0],
                journalEntryId: journalEntry.id,
                transactions: [],
                emi: tenure > 1 ? Math.round(totalAmount / tenure) : totalAmount
            };

            financeData.loans.push(loan);
        }

        function receiveRepayment(contact, amount, toAccount, notes) {
            // Find the loan
            const loan = financeData.loans.find(l => l.contactId == contact.id && l.type === 'given' && l.status === 'active');
            if (!loan) {
                throw new Error(`No active loan found for ${contact.name}`);
            }

            if (amount > loan.currentBalance) {
                throw new Error(`Repayment amount (‚Çπ${amount.toLocaleString()}) exceeds outstanding balance (‚Çπ${loan.currentBalance.toLocaleString()})`);
            }

            // Calculate principal and interest components
            const principalOutstanding = loan.principalAmount - (loan.transactions.filter(t => t.type === 'repayment').reduce((sum, t) => sum + (t.principalComponent || 0), 0));
            const interestOutstanding = loan.interestAmount - (loan.transactions.filter(t => t.type === 'repayment').reduce((sum, t) => sum + (t.interestComponent || 0), 0));
            
            let principalComponent = 0;
            let interestComponent = 0;

            // Allocate payment (interest first, then principal)
            if (interestOutstanding > 0) {
                interestComponent = Math.min(amount, interestOutstanding);
                principalComponent = amount - interestComponent;
            } else {
                principalComponent = amount;
            }

            // Create journal entries
            const entries = [
                { accountId: toAccount, type: 'debit', amount: amount }
            ];

            if (principalComponent > 0) {
                entries.push({ accountId: 'loan_receivable', type: 'credit', amount: principalComponent });
            }

            if (interestComponent > 0) {
                entries.push({ accountId: 'interest_receivable', type: 'credit', amount: interestComponent });
            }

            const journalEntry = createJournalEntry(`Repayment received from ${contact.name} - Principal: ‚Çπ${principalComponent.toLocaleString()}, Interest: ‚Çπ${interestComponent.toLocaleString()}`, entries);

            // Update loan
            loan.currentBalance -= amount;
            if (loan.currentBalance <= 0.01) { // Account for rounding
                loan.status = 'paid';
                loan.currentBalance = 0;
            }

            // Add transaction to loan history
            loan.transactions.push({
                id: Date.now(),
                type: 'repayment',
                amount: amount,
                principalComponent: principalComponent,
                interestComponent: interestComponent,
                date: new Date().toISOString().split('T')[0],
                notes: notes,
                journalEntryId: journalEntry.id,
                outstandingBalance: loan.currentBalance
            });
        }

        function repayLoan(contact, amount, fromAccount, notes) {
            // Find the loan
            const loan = financeData.loans.find(l => l.contactId == contact.id && l.type === 'received' && l.status === 'active');
            if (!loan) {
                throw new Error(`No active loan found from ${contact.name}`);
            }

            if (amount > loan.currentBalance) {
                throw new Error(`Payment amount (‚Çπ${amount.toLocaleString()}) exceeds outstanding balance (‚Çπ${loan.currentBalance.toLocaleString()})`);
            }

            // Check if account has sufficient balance
            const account = financeData.accounts.find(acc => acc.id === fromAccount);
            if (account.balance < amount) {
                throw new Error(`Insufficient balance in ${account.name}. Available: ‚Çπ${account.balance.toLocaleString()}`);
            }

            // Calculate principal and interest components
            const principalOutstanding = loan.principalAmount - (loan.transactions.filter(t => t.type === 'payment').reduce((sum, t) => sum + (t.principalComponent || 0), 0));
            const interestOutstanding = loan.interestAmount - (loan.transactions.filter(t => t.type === 'payment').reduce((sum, t) => sum + (t.interestComponent || 0), 0));
            
            let principalComponent = 0;
            let interestComponent = 0;

            // Allocate payment (interest first, then principal)
            if (interestOutstanding > 0) {
                interestComponent = Math.min(amount, interestOutstanding);
                principalComponent = amount - interestComponent;
            } else {
                principalComponent = amount;
            }

            // Create journal entries
            const entries = [
                { accountId: fromAccount, type: 'credit', amount: amount }
            ];

            if (principalComponent > 0) {
                entries.push({ accountId: 'loan_payable', type: 'debit', amount: principalComponent });
            }

            if (interestComponent > 0) {
                entries.push({ accountId: 'interest_payable', type: 'debit', amount: interestComponent });
            }

            const journalEntry = createJournalEntry(`Payment made to ${contact.name} - Principal: ‚Çπ${principalComponent.toLocaleString()}, Interest: ‚Çπ${interestComponent.toLocaleString()}`, entries);

            // Update loan
            loan.currentBalance -= amount;
            if (loan.currentBalance <= 0.01) { // Account for rounding
                loan.status = 'paid';
                loan.currentBalance = 0;
            }

            // Add transaction to loan history
            loan.transactions.push({
                id: Date.now(),
                type: 'payment',
                amount: amount,
                principalComponent: principalComponent,
                interestComponent: interestComponent,
                date: new Date().toISOString().split('T')[0],
                notes: notes,
                journalEntryId: journalEntry.id,
                outstandingBalance: loan.currentBalance
            });
        }

        // Update Account Balances Display - Professional CA Format
        function updateAccountBalances() {
            const cashAccount = financeData.accounts.find(acc => acc.id === 'cash');
            const bankAccount = financeData.accounts.find(acc => acc.id === 'bank');
            const loanReceivableAccount = financeData.accounts.find(acc => acc.id === 'loan_receivable');
            const loanPayableAccount = financeData.accounts.find(acc => acc.id === 'loan_payable');
            const interestReceivableAccount = financeData.accounts.find(acc => acc.id === 'interest_receivable');
            const interestPayableAccount = financeData.accounts.find(acc => acc.id === 'interest_payable');

            // Calculate total receivables and payables including interest
            const totalReceivables = loanReceivableAccount.balance + interestReceivableAccount.balance;
            const totalPayables = loanPayableAccount.balance + interestPayableAccount.balance;

            document.getElementById('cashBalance').textContent = `‚Çπ${cashAccount.balance.toLocaleString()}`;
            document.getElementById('bankBalance').textContent = `‚Çπ${bankAccount.balance.toLocaleString()}`;
            document.getElementById('loansGivenBalance').textContent = `‚Çπ${totalReceivables.toLocaleString()}`;
            document.getElementById('loansTakenBalance').textContent = `‚Çπ${totalPayables.toLocaleString()}`;

            // Update colors based on balance
            document.getElementById('cashBalance').className = `text-2xl font-bold ${cashAccount.balance >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('bankBalance').className = `text-2xl font-bold ${bankAccount.balance >= 0 ? 'text-blue-600' : 'text-red-600'}`;
            document.getElementById('loansGivenBalance').className = `text-2xl font-bold ${totalReceivables >= 0 ? 'text-purple-600' : 'text-red-600'}`;
            document.getElementById('loansTakenBalance').className = `text-2xl font-bold ${totalPayables >= 0 ? 'text-red-600' : 'text-green-600'}`;
        }

        // Load sample data
        function loadSampleData() {
            const currentDate = new Date().toISOString().split('T')[0];
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthDate = lastMonth.toISOString().split('T')[0];
            
            financeData = {
                transactions: [
                    // Income transactions
                    { id: 1001, type: 'income', amount: 75000, description: 'Monthly Salary', category: 'Other', date: currentDate, timestamp: new Date() },
                    { id: 1002, type: 'income', amount: 5000, description: 'Freelance Project', category: 'Other', date: lastMonthDate, timestamp: new Date(lastMonth) },
                    { id: 1003, type: 'income', amount: 2000, description: 'Investment Returns', category: 'Investment', date: currentDate, timestamp: new Date() },
                    
                    // Expense transactions
                    { id: 1004, type: 'expense', amount: 25000, description: 'Monthly Rent', category: 'Other', date: currentDate, timestamp: new Date() },
                    { id: 1005, type: 'expense', amount: 8000, description: 'Groceries & Food', category: 'Food', date: currentDate, timestamp: new Date() },
                    { id: 1006, type: 'expense', amount: 3500, description: 'Transportation', category: 'Transport', date: currentDate, timestamp: new Date() },
                    { id: 1007, type: 'expense', amount: 2500, description: 'Electricity Bill', category: 'Utilities', date: currentDate, timestamp: new Date() },
                    { id: 1008, type: 'expense', amount: 4000, description: 'Entertainment & Dining', category: 'Entertainment', date: lastMonthDate, timestamp: new Date(lastMonth) },
                    { id: 1009, type: 'expense', amount: 1500, description: 'Mobile & Internet', category: 'Utilities', date: currentDate, timestamp: new Date() },
                    { id: 1010, type: 'expense', amount: 6000, description: 'Health Insurance', category: 'Healthcare', date: currentDate, timestamp: new Date() },
                    
                    // Assets
                    { id: 1011, type: 'asset', amount: 2500000, description: 'Apartment (2BHK)', category: 'Other', date: currentDate, timestamp: new Date() },
                    { id: 1012, type: 'asset', amount: 150000, description: 'Emergency Fund', category: 'Other', date: currentDate, timestamp: new Date() },
                    { id: 1013, type: 'asset', amount: 80000, description: 'Mutual Fund Investment', category: 'Investment', date: currentDate, timestamp: new Date() }
                ],
                budgets: [
                    { id: 2001, category: 'Food', amount: 12000, spent: 8000 },
                    { id: 2002, category: 'Transport', amount: 5000, spent: 3500 },
                    { id: 2003, category: 'Entertainment', amount: 6000, spent: 4000 },
                    { id: 2004, category: 'Utilities', amount: 5000, spent: 4000 },
                    { id: 2005, category: 'Healthcare', amount: 8000, spent: 6000 }
                ],
                goals: [
                    { id: 3001, name: 'Emergency Fund', target: 300000, current: 150000, deadline: '2024-12-31', created: currentDate },
                    { id: 3002, name: 'New Laptop', target: 80000, current: 25000, deadline: '2024-06-30', created: currentDate },
                    { id: 3003, name: 'Vacation Trip', target: 120000, current: 45000, deadline: '2024-08-15', created: currentDate },
                    { id: 3004, name: 'Car Down Payment', target: 200000, current: 75000, deadline: '2024-10-31', created: currentDate }
                ],
                accounts: [
                    { id: 'cash', name: 'Cash in Hand', type: 'asset', balance: 25000, category: 'current' },
                    { id: 'bank', name: 'Bank Account', type: 'asset', balance: 125000, category: 'current' },
                    { id: 'loan_receivable', name: 'Loans Given (Receivable)', type: 'asset', balance: 75000, category: 'current' },
                    { id: 'loan_payable', name: 'Loans Taken (Payable)', type: 'liability', balance: 200000, category: 'current' },
                    { id: 'income', name: 'Income Account', type: 'income', balance: 0, category: 'revenue' },
                    { id: 'expenses', name: 'Expense Account', type: 'expense', balance: 0, category: 'operating' }
                ],
                contacts: [
                    { id: 5001, name: 'Rahul Sharma', phone: '+91 98765 43210', email: 'rahul@example.com', address: 'Mumbai, Maharashtra', created: currentDate },
                    { id: 5002, name: 'Priya Patel', phone: '+91 87654 32109', email: 'priya@example.com', address: 'Ahmedabad, Gujarat', created: currentDate },
                    { id: 5003, name: 'HDFC Bank', phone: '+91 1800 266 4332', email: 'support@hdfcbank.com', address: 'Mumbai Head Office', created: currentDate },
                    { id: 5004, name: 'Amit Kumar', phone: '+91 76543 21098', email: 'amit@example.com', address: 'Delhi, India', created: currentDate }
                ],
                loans: [
                    { 
                        id: 4001, 
                        contactId: 5001,
                        contactName: 'Rahul Sharma',
                        type: 'given', 
                        principalAmount: 50000,
                        currentBalance: 35000,
                        interestRate: 8, 
                        dueDate: '2024-06-15', 
                        status: 'active',
                        notes: 'Personal emergency loan for medical expenses',
                        createdDate: currentDate,
                        transactions: [
                            {
                                id: 6001,
                                type: 'repayment',
                                amount: 15000,
                                date: lastMonthDate,
                                notes: 'Partial repayment',
                                journalEntryId: 7001
                            }
                        ]
                    },
                    { 
                        id: 4002, 
                        contactId: 5002,
                        contactName: 'Priya Patel',
                        type: 'given', 
                        principalAmount: 25000,
                        currentBalance: 25000,
                        interestRate: 5, 
                        dueDate: '2024-08-30', 
                        status: 'active',
                        notes: 'Business startup loan',
                        createdDate: currentDate,
                        transactions: []
                    },
                    { 
                        id: 4003, 
                        contactId: 5003,
                        contactName: 'HDFC Bank',
                        type: 'received', 
                        principalAmount: 500000,
                        currentBalance: 450000,
                        interestRate: 12, 
                        dueDate: '2026-12-31', 
                        status: 'active',
                        notes: 'Personal loan for home renovation',
                        createdDate: currentDate,
                        transactions: [
                            {
                                id: 6002,
                                type: 'payment',
                                amount: 50000,
                                date: lastMonthDate,
                                notes: 'Monthly EMI payment',
                                journalEntryId: 7002
                            }
                        ]
                    }
                ],
                journalEntries: [
                    {
                        id: 7001,
                        date: lastMonthDate,
                        timestamp: new Date(lastMonth),
                        description: 'Repayment received from Rahul Sharma',
                        entries: [
                            { accountId: 'bank', type: 'debit', amount: 15000 },
                            { accountId: 'loan_receivable', type: 'credit', amount: 15000 }
                        ],
                        reference: 'JE7001'
                    },
                    {
                        id: 7002,
                        date: lastMonthDate,
                        timestamp: new Date(lastMonth),
                        description: 'Loan payment to HDFC Bank',
                        entries: [
                            { accountId: 'loan_payable', type: 'debit', amount: 50000 },
                            { accountId: 'bank', type: 'credit', amount: 50000 }
                        ],
                        reference: 'JE7002'
                    }
                ],
                achievements: ['first_transaction', 'first_goal', 'loan_manager', 'analyst'],
                streak: 15,
                lastActivity: new Date().toDateString(),
                notifications: [],
                settings: {
                    enableNotifications: true,
                    notificationSound: true
                }
            };
        }

        // Load sample data manually
        function loadSampleDataManually() {
            if (confirm('This will replace your current data with sample data. Are you sure?')) {
                loadSampleData();
                saveData();
                
                // Refresh all displays
                updateDashboard();
                updateBudgetDisplay();
                updateGoalsDisplay();
                updateLoansDisplay();
                updateReports();
                updateCharts();
                updateAchievements();
                updateSettings();
                
                showNotification('Sample data loaded successfully! Explore all features with realistic examples.', 'success');
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('financeFlowProData', JSON.stringify(financeData));
            } catch (error) {
                console.error('Error saving data:', error);
                if (error.name === 'QuotaExceededError') {
                    showNotification('Storage quota exceeded. Please export your data and clear some records.', 'error');
                } else {
                    showNotification('Error saving data. Changes may not be preserved.', 'error');
                }
            }
        }

        // Mobile menu functionality
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        });

        document.getElementById('mobileOverlay').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.remove('open');
            overlay.classList.add('hidden');
        });

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.remove('hidden');
            document.getElementById(sectionName).classList.add('fade-in');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-green-50', 'text-green-600', 'font-medium');
                btn.classList.add('hover:bg-gray-50', 'text-gray-700');
            });
            
            event.target.classList.add('bg-green-50', 'text-green-600', 'font-medium');
            event.target.classList.remove('hover:bg-gray-50', 'text-gray-700');

            // Close mobile menu
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.remove('open');
            overlay.classList.add('hidden');

            // Update charts if analytics section is shown
            if (sectionName === 'analytics') {
                setTimeout(updateCharts, 100);
            }
        }

        // Enhanced Transaction Form Functions
        function showQuickEntry(type) {
            const form = document.getElementById('transactionForm');
            const title = document.getElementById('formTitle');
            const subtitle = document.getElementById('formSubtitle');
            const amountIcon = document.getElementById('amountIcon');
            const submitButton = document.getElementById('submitButton');
            
            // Set transaction type
            document.getElementById('transactionType').value = type;
            
            // Set today's date as default
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Configure form based on type
            const configs = {
                income: {
                    title: 'üí∞ Add Income',
                    subtitle: 'Record money coming in',
                    icon: 'üí∞',
                    buttonText: 'Add Income',
                    buttonClass: 'bg-green-600 hover:bg-green-700'
                },
                expense: {
                    title: 'üí∏ Add Expense',
                    subtitle: 'Record money going out',
                    icon: 'üí∏',
                    buttonText: 'Add Expense',
                    buttonClass: 'bg-red-600 hover:bg-red-700'
                },
                asset: {
                    title: 'üè† Add Asset',
                    subtitle: 'Record valuable items you own',
                    icon: 'üè†',
                    buttonText: 'Add Asset',
                    buttonClass: 'bg-blue-600 hover:bg-blue-700'
                },
                liability: {
                    title: 'üí≥ Add Liability',
                    subtitle: 'Record money you owe',
                    icon: 'üí≥',
                    buttonText: 'Add Liability',
                    buttonClass: 'bg-orange-600 hover:bg-orange-700'
                }
            };
            
            const config = configs[type];
            title.textContent = config.title;
            subtitle.textContent = config.subtitle;
            amountIcon.textContent = config.icon;
            submitButton.textContent = config.buttonText;
            submitButton.className = `${config.buttonClass} text-white px-8 py-2 rounded-lg transition-colors font-medium`;
            
            // Populate categories and suggestions
            populateCategories(type);
            populateSuggestions(type);
            
            // Show form with animation
            form.classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Focus on amount field
            setTimeout(() => {
                document.getElementById('transactionAmount').focus();
            }, 300);
        }

        function hideTransactionForm() {
            const form = document.getElementById('transactionForm');
            form.classList.add('hidden');
            clearTransactionForm();
        }

        function clearTransactionForm() {
            document.getElementById('transactionType').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionDescription').value = '';
            document.getElementById('transactionNotes').value = '';
            document.getElementById('paymentMethod').value = 'cash';
            
            // Clear category selection
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function populateCategories(type) {
            const categoryGrid = document.getElementById('categoryGrid');
            const categorySelect = document.getElementById('transactionCategory');
            
            const categories = {
                income: [
                    { name: 'Salary', icon: 'üíº' },
                    { name: 'Business', icon: 'üè¢' },
                    { name: 'Investment', icon: 'üìà' },
                    { name: 'Freelance', icon: 'üíª' },
                    { name: 'Bonus', icon: 'üéÅ' },
                    { name: 'Rental', icon: 'üè†' },
                    { name: 'Interest', icon: 'üí∞' },
                    { name: 'Other', icon: 'üìã' }
                ],
                expense: [
                    { name: 'Food', icon: 'üçΩÔ∏è' },
                    { name: 'Transport', icon: 'üöó' },
                    { name: 'Shopping', icon: 'üõçÔ∏è' },
                    { name: 'Utilities', icon: 'üí°' },
                    { name: 'Healthcare', icon: 'üè•' },
                    { name: 'Entertainment', icon: 'üé¨' },
                    { name: 'Education', icon: 'üìö' },
                    { name: 'Other', icon: 'üìã' }
                ],
                asset: [
                    { name: 'Property', icon: 'üè†' },
                    { name: 'Vehicle', icon: 'üöó' },
                    { name: 'Investment', icon: 'üìà' },
                    { name: 'Jewelry', icon: 'üíé' },
                    { name: 'Electronics', icon: 'üì±' },
                    { name: 'Furniture', icon: 'ü™ë' },
                    { name: 'Art', icon: 'üé®' },
                    { name: 'Other', icon: 'üìã' }
                ],
                liability: [
                    { name: 'Home Loan', icon: 'üè†' },
                    { name: 'Car Loan', icon: 'üöó' },
                    { name: 'Credit Card', icon: 'üí≥' },
                    { name: 'Personal Loan', icon: 'üí∞' },
                    { name: 'Education Loan', icon: 'üìö' },
                    { name: 'Business Loan', icon: 'üè¢' },
                    { name: 'Medical Bills', icon: 'üè•' },
                    { name: 'Other', icon: 'üìã' }
                ]
            };
            
            const typeCategories = categories[type] || categories.expense;
            
            // Clear existing categories
            categoryGrid.innerHTML = '';
            categorySelect.innerHTML = '';
            
            // Create category buttons
            typeCategories.forEach(category => {
                // Create visual button
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn p-3 border-2 border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 transition-all text-center';
                button.innerHTML = `
                    <div class="text-xl mb-1">${category.icon}</div>
                    <div class="text-sm font-medium">${category.name}</div>
                `;
                button.onclick = () => selectCategory(category.name, button);
                categoryGrid.appendChild(button);
                
                // Add to hidden select
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        function selectCategory(categoryName, buttonElement) {
            // Remove selection from all buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('selected', 'border-green-500', 'bg-green-100', 'text-green-700');
                btn.classList.add('border-gray-200');
            });
            
            // Select clicked button
            buttonElement.classList.add('selected', 'border-green-500', 'bg-green-100', 'text-green-700');
            buttonElement.classList.remove('border-gray-200');
            
            // Update hidden select
            document.getElementById('transactionCategory').value = categoryName;
        }

        function populateSuggestions(type) {
            const suggestionsContainer = document.getElementById('quickSuggestions');
            
            const suggestions = {
                income: ['Monthly Salary', 'Freelance Payment', 'Investment Return', 'Bonus', 'Rental Income'],
                expense: ['Grocery Shopping', 'Fuel', 'Restaurant', 'Electricity Bill', 'Mobile Recharge'],
                asset: ['Apartment Purchase', 'Car Purchase', 'Gold Investment', 'Mutual Fund', 'Fixed Deposit'],
                liability: ['Home Loan EMI', 'Credit Card Bill', 'Personal Loan', 'Car Loan EMI', 'Medical Bill']
            };
            
            const typeSuggestions = suggestions[type] || suggestions.expense;
            
            suggestionsContainer.innerHTML = '';
            
            typeSuggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors';
                button.textContent = suggestion;
                button.onclick = () => {
                    document.getElementById('transactionDescription').value = suggestion;
                };
                suggestionsContainer.appendChild(button);
            });
        }

        // Enhanced Add Transaction Function with Professional Accounting Integration
        function addTransaction() {
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value.trim();
            const category = document.getElementById('transactionCategory').value;
            const date = document.getElementById('transactionDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('transactionNotes').value.trim();

            // Validation with user-friendly messages
            if (!type) {
                showNotification('Please select a transaction type first', 'error');
                return;
            }

            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount greater than 0', 'error');
                document.getElementById('transactionAmount').focus();
                return;
            }

            if (!description) {
                showNotification('Please enter a description for this transaction', 'error');
                document.getElementById('transactionDescription').focus();
                return;
            }

            if (!category) {
                showNotification('Please select a category', 'error');
                return;
            }

            if (!date) {
                showNotification('Please select a date', 'error');
                return;
            }

            try {
                // Create transaction object
                const transaction = {
                    id: Date.now(),
                    type,
                    amount,
                    description,
                    category,
                    date,
                    paymentMethod,
                    notes,
                    timestamp: new Date()
                };

                financeData.transactions.unshift(transaction);

                // Professional Double-Entry Accounting Integration
                processTransactionAccounting(transaction);
                
                // Update budget spending for expenses
                if (type === 'expense') {
                    updateBudgetSpending(category, amount);
                }
                
                // Auto-contribute to matching goals
                if (type === 'expense' && (description.toLowerCase().includes('saving') || category === 'Investment')) {
                    autoContributeToGoals(description, amount);
                }
                
                // Update all connected displays
                updateDashboard();
                updateBudgetDisplay();
                updateGoalsDisplay();
                updateLoansDisplay();
                updateAccountBalances();
                updateReports();
                updateCharts();
                saveData();
                
                // Success feedback
                const typeEmoji = {
                    income: 'üí∞',
                    expense: 'üí∏',
                    asset: 'üè†',
                    liability: 'üí≥'
                };
                
                showNotification(`${typeEmoji[type]} ${type.charAt(0).toUpperCase() + type.slice(1)} of ‚Çπ${amount.toLocaleString()} added successfully!`, 'success');
                
                // Hide form and clear
                hideTransactionForm();
                

                
            } catch (error) {
                showNotification(`Error processing transaction: ${error.message}`, 'error');
            }
        }

        // Professional Transaction Accounting Processing
        function processTransactionAccounting(transaction) {
            const { type, amount, paymentMethod, category, description } = transaction;
            
            // Determine source/destination account based on payment method
            const sourceAccount = paymentMethod === 'cash' ? 'cash' : 'bank';
            
            // Create appropriate journal entries based on transaction type
            let entries = [];
            
            switch (type) {
                case 'income':
                    // Dr. Cash/Bank, Cr. Income
                    entries = [
                        { accountId: sourceAccount, type: 'debit', amount: amount },
                        { accountId: 'income', type: 'credit', amount: amount }
                    ];
                    break;
                    
                case 'expense':
                    // Dr. Expenses, Cr. Cash/Bank
                    entries = [
                        { accountId: 'expenses', type: 'debit', amount: amount },
                        { accountId: sourceAccount, type: 'credit', amount: amount }
                    ];
                    break;
                    
                case 'asset':
                    // Dr. Asset Account, Cr. Cash/Bank (if purchased)
                    // For now, we'll just increase the asset value
                    entries = [
                        { accountId: sourceAccount, type: 'debit', amount: amount }
                    ];
                    break;
                    
                case 'liability':
                    // Dr. Cash/Bank, Cr. Liability Account (if borrowed)
                    // For now, we'll record as liability increase
                    entries = [
                        { accountId: sourceAccount, type: 'debit', amount: amount }
                    ];
                    break;
            }
            
            // Process journal entries if valid
            if (entries.length >= 2) {
                try {
                    createJournalEntry(`${type.charAt(0).toUpperCase() + type.slice(1)}: ${description}`, entries);
                } catch (error) {
                    console.warn('Journal entry creation failed:', error.message);
                    // Continue with manual account updates for backward compatibility
                    updateAccountsManually(transaction);
                }
            } else {
                updateAccountsManually(transaction);
            }
        }

        // Manual Account Updates (Fallback)
        function updateAccountsManually(transaction) {
            const { type, amount, paymentMethod } = transaction;
            const sourceAccount = paymentMethod === 'cash' ? 'cash' : 'bank';
            
            const cashAccount = financeData.accounts.find(acc => acc.id === 'cash');
            const bankAccount = financeData.accounts.find(acc => acc.id === 'bank');
            const incomeAccount = financeData.accounts.find(acc => acc.id === 'income');
            const expenseAccount = financeData.accounts.find(acc => acc.id === 'expenses');
            
            switch (type) {
                case 'income':
                    if (sourceAccount === 'cash') {
                        cashAccount.balance += amount;
                    } else {
                        bankAccount.balance += amount;
                    }
                    incomeAccount.balance += amount;
                    break;
                    
                case 'expense':
                    if (sourceAccount === 'cash') {
                        cashAccount.balance -= amount;
                    } else {
                        bankAccount.balance -= amount;
                    }
                    expenseAccount.balance += amount;
                    break;
                    
                case 'asset':
                    // Assets increase net worth but don't affect cash unless specified
                    break;
                    
                case 'liability':
                    // Liabilities decrease net worth
                    break;
            }
        }

        // Update Budget Spending with Category Matching
        function updateBudgetSpending(transactionCategory, amount) {
            financeData.budgets.forEach(budget => {
                // Smart category matching - exact match or partial match
                const budgetCat = budget.category.toLowerCase();
                const transCat = transactionCategory.toLowerCase();
                
                if (budgetCat === transCat || 
                    budgetCat.includes(transCat) || 
                    transCat.includes(budgetCat) ||
                    getCategoryAliases(budgetCat).includes(transCat) ||
                    getCategoryAliases(transCat).includes(budgetCat)) {
                    
                    budget.spent = (budget.spent || 0) + amount;
                    
                    // Notify if over budget
                    if (budget.spent > budget.amount) {
                        showNotification(`‚ö†Ô∏è Over budget in ${budget.category}! Spent: ‚Çπ${budget.spent.toLocaleString()}`, 'warning');
                    }
                }
            });
        }

        // Category Aliases for Smart Matching
        function getCategoryAliases(category) {
            const aliases = {
                'food': ['groceries', 'restaurant', 'dining', 'meal', 'snack', 'lunch', 'dinner', 'breakfast'],
                'transport': ['fuel', 'gas', 'petrol', 'taxi', 'uber', 'bus', 'train', 'metro', 'parking'],
                'utilities': ['electricity', 'water', 'gas', 'internet', 'mobile', 'phone', 'wifi'],
                'entertainment': ['movie', 'cinema', 'game', 'music', 'streaming', 'netflix', 'spotify'],
                'healthcare': ['medical', 'doctor', 'hospital', 'medicine', 'pharmacy', 'health', 'dental'],
                'shopping': ['clothes', 'clothing', 'shoes', 'accessories', 'cosmetics', 'beauty'],
                'education': ['course', 'book', 'training', 'certification', 'school', 'college'],
                'investment': ['mutual fund', 'stock', 'share', 'sip', 'fd', 'savings', 'deposit']
            };
            
            return aliases[category] || [];
        }

        // Auto-contribute to Goals
        function autoContributeToGoals(description, amount) {
            const desc = description.toLowerCase();
            
            financeData.goals.forEach(goal => {
                const goalName = goal.name.toLowerCase();
                
                // Check if transaction description matches goal
                if (desc.includes(goalName) || 
                    goalName.includes(desc.split(' ')[0]) ||
                    desc.includes('saving') && goalName.includes('fund')) {
                    
                    goal.current = Math.min(goal.current + amount, goal.target);
                    
                    showNotification(`üí∞ ‚Çπ${amount.toLocaleString()} added to goal: ${goal.name}`, 'success');
                    
                    if (goal.current >= goal.target) {
                        showNotification(`üéâ Goal achieved: ${goal.name}!`, 'success');
                    }
                }
            });
        }

        // Delete Transaction
        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                financeData.transactions = financeData.transactions.filter(t => t.id !== id);
                updateDashboard();
                updateBudgetDisplay();
                updateReports();
                updateCharts();
                saveData();
                showNotification('Transaction deleted successfully', 'success');
            }
        }

        // Clear All Transactions
        function clearAllTransactions() {
            if (confirm('Are you sure you want to delete ALL transactions? This cannot be undone.')) {
                financeData.transactions = [];
                updateDashboard();
                updateBudgetDisplay();
                updateReports();
                updateCharts();
                saveData();
                showNotification('All transactions cleared', 'success');
            }
        }

        // Update Dashboard with Connected Account Balances
        function updateDashboard() {
            // Get real-time account balances from the chart of accounts
            const cashAccount = financeData.accounts.find(acc => acc.id === 'cash') || { balance: 0 };
            const bankAccount = financeData.accounts.find(acc => acc.id === 'bank') || { balance: 0 };
            const incomeAccount = financeData.accounts.find(acc => acc.id === 'income') || { balance: 0 };
            const expenseAccount = financeData.accounts.find(acc => acc.id === 'expenses') || { balance: 0 };
            const loanReceivableAccount = financeData.accounts.find(acc => acc.id === 'loan_receivable') || { balance: 0 };
            const loanPayableAccount = financeData.accounts.find(acc => acc.id === 'loan_payable') || { balance: 0 };
            
            // Calculate totals from transactions (for display consistency)
            const transactionIncome = financeData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const transactionExpenses = financeData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const assets = financeData.transactions
                .filter(t => t.type === 'asset')
                .reduce((sum, t) => sum + t.amount, 0);

            const liabilities = financeData.transactions
                .filter(t => t.type === 'liability')
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Use account balances for accurate cash position
            const totalCashBalance = cashAccount.balance + bankAccount.balance;
            const totalLoanAssets = loanReceivableAccount.balance;
            const totalLoanLiabilities = loanPayableAccount.balance;
            
            // Calculate comprehensive net worth
            const totalAssets = totalCashBalance + assets + totalLoanAssets;
            const totalLiabilities = liabilities + totalLoanLiabilities;
            const netWorth = totalAssets - totalLiabilities;

            // Update dashboard displays with color coding
            document.getElementById('totalBalance').textContent = `‚Çπ${totalCashBalance.toLocaleString()}`;
            document.getElementById('totalBalance').className = `text-2xl font-bold ${totalCashBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('monthlyIncome').textContent = `‚Çπ${transactionIncome.toLocaleString()}`;
            document.getElementById('monthlyExpenses').textContent = `‚Çπ${transactionExpenses.toLocaleString()}`;
            
            document.getElementById('netWorth').textContent = `‚Çπ${netWorth.toLocaleString()}`;
            document.getElementById('netWorth').className = `text-2xl font-bold ${netWorth >= 0 ? 'text-purple-600' : 'text-red-600'}`;

            // Update transactions list with enhanced information
            const transactionsList = document.getElementById('transactionsList');
            if (financeData.transactions.length === 0) {
                transactionsList.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction above!</p>';
            } else {
                transactionsList.innerHTML = financeData.transactions.slice(0, 10).map(transaction => {
                    // Check if this transaction matches any budget
                    const matchingBudgets = financeData.budgets.filter(budget => {
                        if (transaction.type !== 'expense') return false;
                        const budgetCat = budget.category.toLowerCase();
                        const transCat = transaction.category.toLowerCase();
                        const transDesc = transaction.description.toLowerCase();
                        
                        return budgetCat === transCat || 
                               budgetCat.includes(transCat) || 
                               transCat.includes(budgetCat) ||
                               transDesc.includes(budgetCat) ||
                               getCategoryAliases(budgetCat).includes(transCat);
                    });
                    
                    // Check if this transaction contributes to any goal
                    const matchingGoals = financeData.goals.filter(goal => {
                        const desc = transaction.description.toLowerCase();
                        const goalName = goal.name.toLowerCase();
                        return desc.includes(goalName) || 
                               goalName.includes(desc.split(' ')[0]) ||
                               (desc.includes('saving') && goalName.includes('fund'));
                    });
                    
                    return `
                        <div class="item-row flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center ${getTransactionColor(transaction.type)}">
                                    ${getTransactionIcon(transaction.type)}
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${transaction.description}</p>
                                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                                        <span>${transaction.date}</span>
                                        <span>‚Ä¢</span>
                                        <span>${transaction.category}</span>
                                        ${transaction.paymentMethod ? `<span>‚Ä¢ ${transaction.paymentMethod}</span>` : ''}
                                    </div>
                                    ${matchingBudgets.length > 0 ? 
                                        `<div class="text-xs text-blue-600 mt-1">üìä Tracked in: ${matchingBudgets.map(b => b.category).join(', ')}</div>` : ''
                                    }
                                    ${matchingGoals.length > 0 ? 
                                        `<div class="text-xs text-green-600 mt-1">üéØ Contributing to: ${matchingGoals.map(g => g.name).join(', ')}</div>` : ''
                                    }
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-right">
                                    <p class="font-semibold ${getAmountColor(transaction.type)}">
                                        ${getAmountPrefix(transaction.type)}‚Çπ${transaction.amount.toLocaleString()}
                                    </p>
                                    ${transaction.notes ? 
                                        `<p class="text-xs text-gray-400 max-w-20 truncate" title="${transaction.notes}">${transaction.notes}</p>` : ''
                                    }
                                </div>
                                <button onclick="deleteTransaction(${transaction.id})" class="delete-btn text-red-500 hover:text-red-700" title="Delete transaction">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            

        }

        // Helper functions for transaction display
        function getTransactionColor(type) {
            const colors = {
                income: 'bg-green-100 text-green-600',
                expense: 'bg-red-100 text-red-600',
                asset: 'bg-blue-100 text-blue-600',
                liability: 'bg-orange-100 text-orange-600'
            };
            return colors[type] || 'bg-gray-100 text-gray-600';
        }

        function getTransactionIcon(type) {
            const icons = {
                income: 'üìà',
                expense: 'üìâ',
                asset: 'üè†',
                liability: 'üí≥'
            };
            return icons[type] || 'üí∞';
        }

        function getAmountColor(type) {
            const colors = {
                income: 'text-green-600',
                expense: 'text-red-600',
                asset: 'text-blue-600',
                liability: 'text-orange-600'
            };
            return colors[type] || 'text-gray-600';
        }

        function getAmountPrefix(type) {
            return type === 'income' || type === 'asset' ? '+' : '-';
        }

        // Add Budget
        function addBudget() {
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);

            if (!category || !amount) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const budget = {
                id: Date.now(),
                category,
                amount,
                spent: 0
            };

            financeData.budgets.push(budget);
            
            // Clear form
            document.getElementById('budgetCategory').value = '';
            document.getElementById('budgetAmount').value = '';
            
            updateBudgetDisplay();
            saveData();
            
            showNotification(`Budget for ${category} set to ‚Çπ${amount}`, 'success');
        }

        // Delete Budget
        function deleteBudget(id) {
            if (confirm('Are you sure you want to delete this budget?')) {
                financeData.budgets = financeData.budgets.filter(b => b.id !== id);
                updateBudgetDisplay();
                saveData();
                showNotification('Budget deleted successfully', 'success');
            }
        }

        // Update Budget Display with Smart Category Matching
        function updateBudgetDisplay() {
            const budgetCategories = document.getElementById('budgetCategories');
            
            if (financeData.budgets.length === 0) {
                budgetCategories.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                        <p class="text-gray-500">No budgets set yet. Create your first budget above!</p>
                    </div>
                `;
                return;
            }

            // Calculate spent amounts for each budget with smart matching
            financeData.budgets.forEach(budget => {
                budget.spent = 0;
                budget.matchedTransactions = [];
                
                financeData.transactions
                    .filter(t => t.type === 'expense')
                    .forEach(transaction => {
                        const budgetCat = budget.category.toLowerCase();
                        const transCat = transaction.category.toLowerCase();
                        const transDesc = transaction.description.toLowerCase();
                        
                        // Smart matching logic
                        let isMatch = false;
                        
                        // 1. Exact category match
                        if (budgetCat === transCat) {
                            isMatch = true;
                        }
                        // 2. Category contains budget category or vice versa
                        else if (budgetCat.includes(transCat) || transCat.includes(budgetCat)) {
                            isMatch = true;
                        }
                        // 3. Description contains budget category
                        else if (transDesc.includes(budgetCat)) {
                            isMatch = true;
                        }
                        // 4. Check aliases
                        else if (getCategoryAliases(budgetCat).includes(transCat) ||
                                getCategoryAliases(transCat).includes(budgetCat)) {
                            isMatch = true;
                        }
                        // 5. Check if description contains any aliases
                        else {
                            const aliases = getCategoryAliases(budgetCat);
                            isMatch = aliases.some(alias => transDesc.includes(alias));
                        }
                        
                        if (isMatch) {
                            budget.spent += transaction.amount;
                            budget.matchedTransactions.push(transaction);
                        }
                    });
            });

            budgetCategories.innerHTML = financeData.budgets.map(budget => {
                const percentage = budget.amount > 0 ? (budget.spent / budget.amount) * 100 : 0;
                const isOverBudget = percentage > 100;
                const isNearLimit = percentage > 80 && percentage <= 100;
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${budget.category}</h3>
                                <p class="text-xs text-gray-500">${budget.matchedTransactions.length} transactions matched</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm ${isOverBudget ? 'text-red-600' : isNearLimit ? 'text-yellow-600' : 'text-gray-500'}">
                                    ${percentage.toFixed(1)}% used
                                </span>
                                <button onclick="showBudgetDetails(${budget.id})" class="text-blue-500 hover:text-blue-700 text-xs" title="View details">
                                    üìä
                                </button>
                                <button onclick="deleteBudget(${budget.id})" class="delete-btn text-red-500 hover:text-red-700" title="Delete budget">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>‚Çπ${budget.spent.toLocaleString()} spent</span>
                                <span>‚Çπ${budget.amount.toLocaleString()} budget</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="progress-animation h-3 rounded-full ${
                                    isOverBudget ? 'bg-red-500' : 
                                    isNearLimit ? 'bg-yellow-500' : 'bg-green-500'
                                }" 
                                     style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                        </div>
                        ${isOverBudget ? 
                            `<p class="text-sm text-red-600 font-medium">‚ö†Ô∏è Over budget by ‚Çπ${(budget.spent - budget.amount).toLocaleString()}!</p>` : 
                            isNearLimit ?
                            `<p class="text-sm text-yellow-600 font-medium">‚ö° Near limit! ‚Çπ${(budget.amount - budget.spent).toLocaleString()} remaining</p>` :
                            `<p class="text-sm text-green-600">‚Çπ${(budget.amount - budget.spent).toLocaleString()} remaining</p>`
                        }
                        ${budget.matchedTransactions.length > 0 ? 
                            `<div class="mt-2 text-xs text-gray-500">
                                Recent: ${budget.matchedTransactions.slice(-3).map(t => t.description).join(', ')}
                            </div>` : ''
                        }
                    </div>
                `;
            }).join('');
        }

        // Show Budget Details
        function showBudgetDetails(budgetId) {
            const budget = financeData.budgets.find(b => b.id === budgetId);
            if (!budget) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-gray-800">üìä ${budget.category} Budget Details</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Budget Amount:</span>
                                <span class="text-lg font-bold text-blue-600">‚Çπ${budget.amount.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Amount Spent:</span>
                                <span class="text-lg font-bold text-red-600">‚Çπ${budget.spent.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="font-medium">Remaining:</span>
                                <span class="text-lg font-bold ${budget.spent <= budget.amount ? 'text-green-600' : 'text-red-600'}">
                                    ‚Çπ${(budget.amount - budget.spent).toLocaleString()}
                                </span>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold text-gray-800 mb-3">Matched Transactions (${budget.matchedTransactions.length})</h4>
                        ${budget.matchedTransactions.length === 0 ? 
                            '<p class="text-gray-500 text-center py-4">No transactions matched this budget category yet.</p>' :
                            `<div class="space-y-2 max-h-48 overflow-y-auto">
                                ${budget.matchedTransactions.map(transaction => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-gray-800">${transaction.description}</p>
                                            <p class="text-sm text-gray-500">${transaction.date} ‚Ä¢ ${transaction.category}</p>
                                        </div>
                                        <span class="font-semibold text-red-600">‚Çπ${transaction.amount.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Add Goal
        function addGoal() {
            const name = document.getElementById('goalName').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const deadline = document.getElementById('goalDeadline').value;

            if (!name || !target || !deadline) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const goal = {
                id: Date.now(),
                name,
                target,
                current: 0,
                deadline,
                created: new Date().toISOString().split('T')[0]
            };

            financeData.goals.push(goal);
            
            // Clear form
            document.getElementById('goalName').value = '';
            document.getElementById('goalTarget').value = '';
            document.getElementById('goalDeadline').value = '';
            
            updateGoalsDisplay();
            saveData();
            
            showNotification(`Goal "${name}" created successfully!`, 'success');
        }

        // Delete Goal
        function deleteGoal(id) {
            if (confirm('Are you sure you want to delete this goal?')) {
                financeData.goals = financeData.goals.filter(g => g.id !== id);
                updateGoalsDisplay();
                saveData();
                showNotification('Goal deleted successfully', 'success');
            }
        }

        // Update Goals Display with Smart Transaction Matching
        function updateGoalsDisplay() {
            const goalsList = document.getElementById('goalsList');
            
            if (financeData.goals.length === 0) {
                goalsList.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                        <p class="text-gray-500">No goals set yet. Create your first goal above!</p>
                    </div>
                `;
                return;
            }

            // Auto-update goals based on matching transactions
            financeData.goals.forEach(goal => {
                // Find transactions that might contribute to this goal
                const contributingTransactions = financeData.transactions.filter(transaction => {
                    if (transaction.type !== 'expense') return false;
                    
                    const desc = transaction.description.toLowerCase();
                    const goalName = goal.name.toLowerCase();
                    const category = transaction.category.toLowerCase();
                    
                    // Smart matching for goal contributions
                    return desc.includes(goalName) || 
                           goalName.includes(desc.split(' ')[0]) ||
                           (desc.includes('saving') && goalName.includes('fund')) ||
                           (desc.includes('investment') && goalName.includes('investment')) ||
                           (category === 'investment' && goalName.includes('fund')) ||
                           desc.includes('sip') || desc.includes('mutual fund') ||
                           desc.includes('deposit');
                });
                
                // Store contributing transactions for display
                goal.contributingTransactions = contributingTransactions;
                
                // Auto-calculate current amount from contributing transactions
                const autoContributed = contributingTransactions.reduce((sum, t) => sum + t.amount, 0);
                
                // Update current amount if auto-contributions exist and current is less than calculated
                if (autoContributed > 0 && goal.current < autoContributed) {
                    goal.current = Math.min(autoContributed, goal.target);
                }
            });

            goalsList.innerHTML = financeData.goals.map(goal => {
                const percentage = (goal.current / goal.target) * 100;
                const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                const isCompleted = percentage >= 100;
                const isNearDeadline = daysLeft <= 30 && daysLeft > 0;
                const isOverdue = daysLeft < 0;
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 ${isCompleted ? 'ring-2 ring-green-200' : ''}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h3 class="text-xl font-semibold text-gray-800">${goal.name}</h3>
                                    ${isCompleted ? '<span class="text-green-600 text-xl">üéâ</span>' : ''}
                                </div>
                                <p class="text-sm ${isOverdue ? 'text-red-500' : isNearDeadline ? 'text-yellow-600' : 'text-gray-500'}">
                                    ${isOverdue ? `Overdue by ${Math.abs(daysLeft)} days` : 
                                      daysLeft > 0 ? `${daysLeft} days left` : 'Deadline today'}
                                </p>
                                ${goal.contributingTransactions && goal.contributingTransactions.length > 0 ? 
                                    `<p class="text-xs text-blue-600 mt-1">üìä ${goal.contributingTransactions.length} auto-matched transactions</p>` : ''
                                }
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-right">
                                    <p class="text-lg font-bold ${isCompleted ? 'text-green-600' : 'text-blue-600'}">
                                        ‚Çπ${goal.current.toLocaleString()}
                                    </p>
                                    <p class="text-sm text-gray-500">of ‚Çπ${goal.target.toLocaleString()}</p>
                                </div>
                                <button onclick="showGoalDetails(${goal.id})" class="text-blue-500 hover:text-blue-700 text-xs" title="View details">
                                    üìä
                                </button>
                                <button onclick="deleteGoal(${goal.id})" class="delete-btn text-red-500 hover:text-red-700" title="Delete goal">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="progress-animation h-3 rounded-full ${
                                    isCompleted ? 'bg-green-500' : 
                                    percentage > 75 ? 'bg-blue-500' : 
                                    percentage > 50 ? 'bg-yellow-500' : 'bg-gray-400'
                                }" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <p class="text-sm text-gray-600">${percentage.toFixed(1)}% complete</p>
                                ${!isCompleted ? 
                                    `<p class="text-sm text-gray-500">‚Çπ${(goal.target - goal.current).toLocaleString()} remaining</p>` :
                                    '<p class="text-sm text-green-600 font-medium">Goal Achieved! üéØ</p>'
                                }
                            </div>
                        </div>
                        ${!isCompleted ? `
                            <div class="flex space-x-2">
                                <input type="number" id="goalContribution${goal.id}" placeholder="Add amount" 
                                       class="flex-1 p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <button onclick="addToGoal(${goal.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    Add
                                </button>
                            </div>
                        ` : `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                <p class="text-green-800 font-medium">üéâ Congratulations! Goal achieved!</p>
                                <p class="text-green-600 text-sm">You've successfully saved ‚Çπ${goal.target.toLocaleString()}</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Show Goal Details
        function showGoalDetails(goalId) {
            const goal = financeData.goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-gray-800">üéØ ${goal.name} - Goal Details</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Target Amount:</span>
                                <span class="text-lg font-bold text-blue-600">‚Çπ${goal.target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Current Amount:</span>
                                <span class="text-lg font-bold text-green-600">‚Çπ${goal.current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Remaining:</span>
                                <span class="text-lg font-bold ${goal.current >= goal.target ? 'text-green-600' : 'text-orange-600'}">
                                    ‚Çπ${Math.max(0, goal.target - goal.current).toLocaleString()}
                                </span>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="font-medium">Deadline:</span>
                                <span class="font-medium">${goal.deadline}</span>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold text-gray-800 mb-3">Contributing Transactions (${goal.contributingTransactions ? goal.contributingTransactions.length : 0})</h4>
                        ${!goal.contributingTransactions || goal.contributingTransactions.length === 0 ? 
                            '<p class="text-gray-500 text-center py-4">No transactions automatically matched this goal yet.</p>' :
                            `<div class="space-y-2 max-h-48 overflow-y-auto">
                                ${goal.contributingTransactions.map(transaction => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-gray-800">${transaction.description}</p>
                                            <p class="text-sm text-gray-500">${transaction.date} ‚Ä¢ ${transaction.category}</p>
                                        </div>
                                        <span class="font-semibold text-green-600">‚Çπ${transaction.amount.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Add to Goal
        function addToGoal(goalId) {
            const input = document.getElementById(`goalContribution${goalId}`);
            const amount = parseFloat(input.value);
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            const goal = financeData.goals.find(g => g.id === goalId);
            if (goal) {
                goal.current += amount;
                input.value = '';
                
                // Add as expense transaction
                const transaction = {
                    id: Date.now(),
                    type: 'expense',
                    amount,
                    description: `Savings for ${goal.name}`,
                    category: 'Investment',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date()
                };
                financeData.transactions.unshift(transaction);
                
                updateGoalsDisplay();
                updateDashboard();
                updateReports();
                updateCharts();
                saveData();
                
                if (goal.current >= goal.target) {
                    showNotification(`üéâ Congratulations! You've reached your goal: ${goal.name}!`, 'success');
                } else {
                    showNotification(`‚Çπ${amount} added to ${goal.name}`, 'success');
                }
            }
        }

        // Add Loan
        function addLoan() {
            const type = document.getElementById('loanType').value;
            const person = document.getElementById('loanPerson').value;
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const interest = parseFloat(document.getElementById('loanInterest').value) || 0;
            const dueDate = document.getElementById('loanDueDate').value;
            const paymentFreq = document.getElementById('loanPaymentFreq').value;
            const installments = parseInt(document.getElementById('loanInstallments').value) || 1;
            const installmentAmount = parseFloat(document.getElementById('loanInstallmentAmount').value) || amount;
            const notes = document.getElementById('loanNotes').value;
            const reminderEnabled = document.getElementById('loanReminder').checked;
            const reminderDays = parseInt(document.getElementById('loanReminderDays').value) || 7;

            if (!person || !amount || !dueDate) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const loan = {
                id: Date.now(),
                type,
                person,
                amount,
                interest,
                dueDate,
                paymentFreq,
                installments,
                installmentAmount,
                notes,
                reminderEnabled,
                reminderDays,
                status: 'active',
                createdDate: new Date().toISOString().split('T')[0],
                paidInstallments: 0,
                nextPaymentDate: dueDate
            };

            // Calculate next payment dates for installments
            if (paymentFreq !== 'one-time') {
                loan.paymentSchedule = generatePaymentSchedule(loan);
            }

            financeData.loans.push(loan);
            
            // Add corresponding transaction
            const transaction = {
                id: Date.now() + 1,
                type: type === 'given' ? 'expense' : 'income',
                amount,
                description: `Loan ${type} - ${person}`,
                category: 'Loan',
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date()
            };
            financeData.transactions.unshift(transaction);
            
            // Schedule notifications if enabled
            if (reminderEnabled) {
                scheduleNotifications(loan);
            }
            
            // Clear form
            clearLoanForm();
            
            updateLoansDisplay();
            updateDashboard();
            updateReports();
            updateCharts();
            saveData();
            
            showNotification(`Loan ${type} to/from ${person} recorded successfully!`, 'success');
        }

        // Generate Payment Schedule
        function generatePaymentSchedule(loan) {
            const schedule = [];
            const startDate = new Date(loan.dueDate);
            
            for (let i = 0; i < loan.installments; i++) {
                const paymentDate = new Date(startDate);
                
                switch (loan.paymentFreq) {
                    case 'monthly':
                        paymentDate.setMonth(paymentDate.getMonth() + i);
                        break;
                    case 'quarterly':
                        paymentDate.setMonth(paymentDate.getMonth() + (i * 3));
                        break;
                    case 'yearly':
                        paymentDate.setFullYear(paymentDate.getFullYear() + i);
                        break;
                }
                
                schedule.push({
                    installmentNumber: i + 1,
                    dueDate: paymentDate.toISOString().split('T')[0],
                    amount: loan.installmentAmount,
                    status: 'pending'
                });
            }
            
            return schedule;
        }

        // Schedule Notifications
        function scheduleNotifications(loan) {
            const today = new Date();
            const dueDate = new Date(loan.dueDate);
            const reminderDate = new Date(dueDate);
            reminderDate.setDate(reminderDate.getDate() - loan.reminderDays);
            
            if (reminderDate >= today) {
                const notification = {
                    id: Date.now(),
                    type: 'loan_reminder',
                    title: `Loan Payment Reminder`,
                    message: `${loan.type === 'given' ? 'Loan repayment' : 'Loan payment'} of ‚Çπ${loan.amount.toLocaleString()} ${loan.type === 'given' ? 'from' : 'to'} ${loan.person} is due on ${loan.dueDate}`,
                    dueDate: loan.dueDate,
                    reminderDate: reminderDate.toISOString().split('T')[0],
                    loanId: loan.id,
                    status: 'scheduled'
                };
                
                financeData.notifications.push(notification);
            }
        }

        // Clear Loan Form
        function clearLoanForm() {
            document.getElementById('loanPerson').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanInterest').value = '';
            document.getElementById('loanDueDate').value = '';
            document.getElementById('loanPaymentFreq').value = 'one-time';
            document.getElementById('loanInstallments').value = '';
            document.getElementById('loanInstallmentAmount').value = '';
            document.getElementById('loanNotes').value = '';
            document.getElementById('loanReminder').checked = false;
            document.getElementById('loanReminderDays').value = '7';
            
            // Hide installment fields
            document.getElementById('loanInstallments').classList.add('hidden');
            document.getElementById('loanInstallmentAmount').classList.add('hidden');
            document.getElementById('loanReminderDays').classList.add('hidden');
        }

        // Delete Loan
        function deleteLoan(id) {
            if (confirm('Are you sure you want to delete this loan record?')) {
                financeData.loans = financeData.loans.filter(l => l.id !== id);
                updateLoansDisplay();
                updateReports();
                saveData();
                showNotification('Loan record deleted successfully', 'success');
            }
        }

        // Mark Loan as Paid
        function markLoanPaid(id) {
            const loan = financeData.loans.find(l => l.id === id);
            if (loan) {
                loan.status = 'paid';
                
                // Calculate total amount with interest
                const totalAmount = loan.amount * (1 + loan.interest / 100);
                
                // Add repayment transaction
                const transaction = {
                    id: Date.now(),
                    type: loan.type === 'given' ? 'income' : 'expense',
                    amount: totalAmount,
                    description: `Loan repayment - ${loan.person}`,
                    category: 'Loan',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date()
                };
                financeData.transactions.unshift(transaction);
                
                updateLoansDisplay();
                updateDashboard();
                updateReports();
                updateCharts();
                saveData();
                
                showNotification(`Loan from ${loan.person} marked as paid!`, 'success');
            }
        }

        // Clear All Loans
        function clearAllLoans() {
            if (confirm('Are you sure you want to delete ALL loan records? This cannot be undone.')) {
                financeData.loans = [];
                updateLoansDisplay();
                updateReports();
                saveData();
                showNotification('All loan records cleared', 'success');
            }
        }

        // Update Loans Display
        function updateLoansDisplay() {
            const activeLoansDisplay = document.getElementById('activeLoansDisplay');
            const recentTransactionsDisplay = document.getElementById('recentLoanTransactions');
            
            // Display active loans
            const activeLoans = financeData.loans.filter(l => l.status === 'active');
            
            if (activeLoans.length === 0) {
                activeLoansDisplay.innerHTML = '<p class="text-gray-500 text-center py-8">No active loans. Use the buttons above to start managing loans!</p>';
            } else {
                activeLoansDisplay.innerHTML = activeLoans.map(loan => {
                    const daysUntilDue = Math.ceil((new Date(loan.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    const isOverdue = daysUntilDue < 0;
                    const isDueSoon = daysUntilDue <= 7 && daysUntilDue >= 0;
                    
                    let statusClass = '';
                    let statusText = '';
                    let statusIcon = '';
                    
                    if (isOverdue) {
                        statusClass = 'border-l-4 border-red-500 bg-red-50';
                        statusText = `Overdue by ${Math.abs(daysUntilDue)} days`;
                        statusIcon = '‚ö†Ô∏è';
                    } else if (isDueSoon) {
                        statusClass = 'border-l-4 border-yellow-500 bg-yellow-50';
                        statusText = `Due in ${daysUntilDue} days`;
                        statusIcon = '‚è∞';
                    } else {
                        statusClass = 'border-l-4 border-gray-300 bg-white';
                        statusText = `Due in ${daysUntilDue} days`;
                        statusIcon = 'üìÖ';
                    }
                    
                    const typeColor = loan.type === 'given' ? 'text-green-600' : 'text-blue-600';
                    const typeIcon = loan.type === 'given' ? 'üì§' : 'üì•';
                    
                    return `
                        <div class="p-4 rounded-lg border ${statusClass}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">${typeIcon}</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${loan.contactName}</h4>
                                        <p class="text-sm text-gray-600">${loan.type === 'given' ? 'Money Lent' : 'Money Borrowed'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold ${typeColor}">‚Çπ${loan.currentBalance.toLocaleString()}</p>
                                    <p class="text-sm text-gray-500">of ‚Çπ${loan.principalAmount.toLocaleString()}</p>
                                    ${loan.interestRate > 0 ? `<p class="text-xs text-gray-500">${loan.interestRate}% interest</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">${statusIcon}</span>
                                    <span class="text-sm text-gray-600">${statusText}</span>
                                </div>
                                <div class="text-xs text-gray-500">Due: ${loan.dueDate}</div>
                            </div>
                            
                            ${loan.notes ? `<p class="text-sm text-gray-600 mb-3 italic">"${loan.notes}"</p>` : ''}
                            
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-2">
                                    ${loan.type === 'given' ? `
                                        <button onclick="quickRepayment('${loan.contactId}')" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors">
                                            üìà Receive Payment
                                        </button>
                                    ` : `
                                        <button onclick="quickPayment('${loan.contactId}')" class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700 transition-colors">
                                            üìâ Make Payment
                                        </button>
                                    `}
                                </div>
                                <button onclick="deleteLoan(${loan.id})" class="text-red-500 hover:text-red-700 text-sm" title="Delete loan">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Display recent loan transactions
            const recentTransactions = [];
            financeData.loans.forEach(loan => {
                if (loan.transactions) {
                    loan.transactions.forEach(transaction => {
                        recentTransactions.push({
                            ...transaction,
                            contactName: loan.contactName,
                            loanType: loan.type
                        });
                    });
                }
            });
            
            // Sort by date (most recent first)
            recentTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (recentTransactions.length === 0) {
                recentTransactionsDisplay.innerHTML = '<p class="text-gray-500 text-center py-8">No loan transactions yet.</p>';
            } else {
                recentTransactionsDisplay.innerHTML = recentTransactions.slice(0, 10).map(transaction => {
                    const typeIcon = transaction.type === 'repayment' ? 'üìà' : 'üìâ';
                    const typeColor = transaction.type === 'repayment' ? 'text-green-600' : 'text-red-600';
                    const typeText = transaction.type === 'repayment' ? 'Repayment Received' : 'Payment Made';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="text-xl">${typeIcon}</div>
                                <div>
                                    <p class="font-medium text-gray-800">${typeText}</p>
                                    <p class="text-sm text-gray-600">${transaction.contactName} ‚Ä¢ ${transaction.date}</p>
                                    ${transaction.notes ? `<p class="text-xs text-gray-500">${transaction.notes}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold ${typeColor}">‚Çπ${transaction.amount.toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Quick action functions
        function quickRepayment(contactId) {
            const contact = financeData.contacts.find(c => c.id == contactId);
            if (contact) {
                document.getElementById('loanContact').value = contactId;
                showLoanAction('repayment');
            }
        }

        function quickPayment(contactId) {
            const contact = financeData.contacts.find(c => c.id == contactId);
            if (contact) {
                document.getElementById('loanContact').value = contactId;
                showLoanAction('repay');
            }
        }

        // Contact Management
        function showContacts() {
            // Create a modal for contact management
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-gray-800">üë• Manage Contacts</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        ${financeData.contacts.length === 0 ? 
                            '<p class="text-gray-500 text-center py-8">No contacts yet. Contacts will be created automatically when you add loans.</p>' :
                            financeData.contacts.map(contact => `
                                <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-800">${contact.name}</h4>
                                        <p class="text-sm text-gray-500">Added: ${contact.created}</p>
                                    </div>
                                    <button onclick="deleteContact(${contact.id}); this.closest('.fixed').remove();" class="text-red-500 hover:text-red-700 text-sm">
                                        Delete
                                    </button>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function deleteContact(contactId) {
            // Check if contact has active loans
            const hasActiveLoans = financeData.loans.some(l => l.contactId == contactId && l.status === 'active');
            
            if (hasActiveLoans) {
                showNotification('Cannot delete contact with active loans', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this contact?')) {
                financeData.contacts = financeData.contacts.filter(c => c.id != contactId);
                saveData();
                showNotification('Contact deleted successfully', 'success');
            }
        }

        // Chart instances storage
        let chartInstances = {};

        // Update Charts
        function updateCharts() {
            try {
                // Destroy existing charts before creating new ones
                Object.values(chartInstances).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                chartInstances = {};
                
                setTimeout(() => {
                    try {
                        updateIncomeExpenseChart();
                        updateCategoryChart();
                        updateTrendChart();
                    } catch (error) {
                        console.error('Error updating charts:', error);
                    }
                }, 100);
            } catch (error) {
                console.error('Error in updateCharts:', error);
            }
        }

        // Income vs Expenses Chart
        function updateIncomeExpenseChart() {
            const ctx = document.getElementById('incomeExpenseChart');
            if (!ctx) return;

            const income = financeData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = financeData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            if (income === 0 && expenses === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const context = ctx.getContext('2d');
                context.font = '16px Inter';
                context.fillStyle = '#6b7280';
                context.textAlign = 'center';
                context.fillText('No data available', ctx.width / 2, ctx.height / 2);
                return;
            }

            chartInstances.incomeExpense = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expenses'],
                    datasets: [{
                        data: [income, expenses],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: ['#059669', '#dc2626'],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Category Breakdown Chart
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            const categoryData = {};
            financeData.transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    categoryData[t.category] = (categoryData[t.category] || 0) + t.amount;
                });

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            if (labels.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const context = ctx.getContext('2d');
                context.font = '16px Inter';
                context.fillStyle = '#6b7280';
                context.textAlign = 'center';
                context.fillText('No expense data', ctx.width / 2, ctx.height / 2);
                return;
            }

            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'];

            chartInstances.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ‚Çπ${context.parsed.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Monthly Trend Chart
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            // Group transactions by month
            const monthlyData = {};
            financeData.transactions.forEach(t => {
                const month = t.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expenses: 0 };
                }
                if (t.type === 'income') {
                    monthlyData[month].income += t.amount;
                } else if (t.type === 'expense') {
                    monthlyData[month].expenses += t.amount;
                }
            });

            const months = Object.keys(monthlyData).sort();
            
            if (months.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const context = ctx.getContext('2d');
                context.font = '16px Inter';
                context.fillStyle = '#6b7280';
                context.textAlign = 'center';
                context.fillText('No monthly data available', ctx.width / 2, ctx.height / 2);
                return;
            }

            const incomeData = months.map(m => monthlyData[m].income);
            const expenseData = months.map(m => monthlyData[m].expenses);

            chartInstances.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }, {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                color: '#f3f4f6'
                            }
                        }
                    }
                }
            });
        }

        // Show Report
        function showReport(reportType) {
            // Hide all report contents
            document.querySelectorAll('.report-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected report
            document.getElementById(reportType).classList.remove('hidden');
            
            // Update tab styles
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.classList.remove('border-green-500', 'text-green-600', 'font-medium');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            event.target.classList.add('border-green-500', 'text-green-600', 'font-medium');
            event.target.classList.remove('border-transparent', 'text-gray-500');
        }

        // Update Reports
        function updateReports() {
            updateBalanceSheet();
            updateIncomeStatement();
            updateCashFlowStatement();
        }

        // Professional Balance Sheet - CA Level Accounting
        function updateBalanceSheet() {
            const assets = financeData.transactions.filter(t => t.type === 'asset');
            const liabilities = financeData.transactions.filter(t => t.type === 'liability');
            
            // Get account balances from the chart of accounts
            const cashAccount = financeData.accounts.find(acc => acc.id === 'cash');
            const bankAccount = financeData.accounts.find(acc => acc.id === 'bank');
            const loanReceivableAccount = financeData.accounts.find(acc => acc.id === 'loan_receivable');
            const loanPayableAccount = financeData.accounts.find(acc => acc.id === 'loan_payable');
            const interestReceivableAccount = financeData.accounts.find(acc => acc.id === 'interest_receivable');
            const interestPayableAccount = financeData.accounts.find(acc => acc.id === 'interest_payable');
            const incomeAccount = financeData.accounts.find(acc => acc.id === 'income');
            const interestIncomeAccount = financeData.accounts.find(acc => acc.id === 'interest_income');
            const expenseAccount = financeData.accounts.find(acc => acc.id === 'expenses');
            const interestExpenseAccount = financeData.accounts.find(acc => acc.id === 'interest_expense');
            
            // Calculate current assets
            const totalCash = cashAccount.balance + bankAccount.balance;
            const totalReceivables = loanReceivableAccount.balance + interestReceivableAccount.balance;
            const totalCurrentAssets = totalCash + totalReceivables;
            
            // Calculate non-current assets
            const totalFixedAssets = assets.reduce((sum, t) => sum + t.amount, 0);
            
            // Total assets
            const totalAssets = totalCurrentAssets + totalFixedAssets;
            
            // Calculate current liabilities
            const totalPayables = loanPayableAccount.balance + interestPayableAccount.balance;
            const totalCurrentLiabilities = totalPayables;
            
            // Calculate non-current liabilities
            const totalFixedLiabilities = liabilities.reduce((sum, t) => sum + t.amount, 0);
            
            // Total liabilities
            const totalLiabilities = totalCurrentLiabilities + totalFixedLiabilities;
            
            // Calculate equity (retained earnings)
            const totalIncome = incomeAccount.balance + interestIncomeAccount.balance;
            const totalExpenses = expenseAccount.balance + interestExpenseAccount.balance;
            const retainedEarnings = totalIncome - totalExpenses;
            
            // Net worth (Total Assets should equal Total Liabilities + Equity)
            const netWorth = totalAssets - totalLiabilities;

            // Generate financial analysis and suggestions
            const analysis = generateFinancialAnalysis(totalAssets, totalLiabilities, cashBalance, totalCurrentAssets, totalCurrentLiabilities);

            // Professional Balance Sheet Display - CA Format
            const assetsList = document.getElementById('assetsList');
            let assetsHTML = `
                <div class="mb-4">
                    <h5 class="font-semibold text-gray-700 mb-2 text-sm uppercase tracking-wide">Current Assets</h5>
            `;
            
            // Current Assets - Professional Format
            if (totalCash > 0) {
                assetsHTML += `
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-sm">Cash in Hand</span>
                        <span class="text-sm font-medium">‚Çπ${cashAccount.balance.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-sm">Bank Balance</span>
                        <span class="text-sm font-medium">‚Çπ${bankAccount.balance.toLocaleString()}</span>
                    </div>
                `;
            }
            
            if (loanReceivableAccount.balance > 0) {
                assetsHTML += `
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-sm">Loans & Advances (Receivable)</span>
                        <span class="text-sm font-medium">‚Çπ${loanReceivableAccount.balance.toLocaleString()}</span>
                    </div>
                `;
            }

            if (interestReceivableAccount.balance > 0) {
                assetsHTML += `
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-sm">Interest Receivable</span>
                        <span class="text-sm font-medium">‚Çπ${interestReceivableAccount.balance.toLocaleString()}</span>
                    </div>
                `;
            }
            
            assetsHTML += `
                    <div class="flex justify-between py-2 font-semibold text-green-600 border-t-2 border-green-200 mt-2">
                        <span class="text-sm">Total Current Assets</span>
                        <span class="text-sm">‚Çπ${totalCurrentAssets.toLocaleString()}</span>
                    </div>
                </div>
            `;

            // Non-Current Assets
            if (assets.length > 0) {
                assetsHTML += `
                    <div class="mb-4">
                        <h5 class="font-semibold text-gray-700 mb-2 text-sm uppercase tracking-wide">Non-Current Assets</h5>
                `;
                
                assets.forEach(asset => {
                    assetsHTML += `
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-sm">${asset.description}</span>
                            <span class="text-sm font-medium">‚Çπ${asset.amount.toLocaleString()}</span>
                        </div>
                    `;
                });
                
                assetsHTML += `
                        <div class="flex justify-between py-2 font-semibold text-blue-600 border-t-2 border-blue-200 mt-2">
                            <span class="text-sm">Total Non-Current Assets</span>
                            <span class="text-sm">‚Çπ${totalFixedAssets.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }
            
            if (totalAssets === 0) {
                assetsList.innerHTML = '<p class="text-gray-500 text-sm">No assets recorded</p>';
            } else {
                assetsList.innerHTML = assetsHTML;
            }

            // Professional Liabilities Display - CA Format
            const liabilitiesList = document.getElementById('liabilitiesList');
            let liabilitiesHTML = `
                <div class="mb-4">
                    <h5 class="font-semibold text-gray-700 mb-2 text-sm uppercase tracking-wide">Current Liabilities</h5>
            `;
            
            // Current Liabilities - Professional Format
            if (loanPayableAccount.balance > 0) {
                liabilitiesHTML += `
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-sm">Loans & Borrowings (Payable)</span>
                        <span class="text-sm font-medium">‚Çπ${loanPayableAccount.balance.toLocaleString()}</span>
                    </div>
                `;
            }

            if (interestPayableAccount.balance > 0) {
                liabilitiesHTML += `
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-sm">Interest Payable</span>
                        <span class="text-sm font-medium">‚Çπ${interestPayableAccount.balance.toLocaleString()}</span>
                    </div>
                `;
            }
            
            liabilitiesHTML += `
                    <div class="flex justify-between py-2 font-semibold text-orange-600 border-t-2 border-orange-200 mt-2">
                        <span class="text-sm">Total Current Liabilities</span>
                        <span class="text-sm">‚Çπ${totalCurrentLiabilities.toLocaleString()}</span>
                    </div>
                </div>
            `;

            // Non-Current Liabilities
            if (liabilities.length > 0) {
                liabilitiesHTML += `
                    <div class="mb-4">
                        <h5 class="font-semibold text-gray-700 mb-2 text-sm uppercase tracking-wide">Non-Current Liabilities</h5>
                `;
                
                liabilities.forEach(liability => {
                    liabilitiesHTML += `
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-sm">${liability.description}</span>
                            <span class="text-sm font-medium">‚Çπ${liability.amount.toLocaleString()}</span>
                        </div>
                    `;
                });
                
                liabilitiesHTML += `
                        <div class="flex justify-between py-2 font-semibold text-red-600 border-t-2 border-red-200 mt-2">
                            <span class="text-sm">Total Non-Current Liabilities</span>
                            <span class="text-sm">‚Çπ${totalFixedLiabilities.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }
            
            if (totalLiabilities === 0) {
                liabilitiesList.innerHTML = '<p class="text-gray-500 text-sm">No liabilities recorded</p>';
            } else {
                liabilitiesList.innerHTML = liabilitiesHTML;
            }

            // Update totals
            document.getElementById('totalAssets').textContent = `‚Çπ${totalAssets.toLocaleString()}`;
            document.getElementById('totalLiabilities').textContent = `‚Çπ${totalLiabilities.toLocaleString()}`;
            document.getElementById('balanceSheetNetWorth').textContent = `‚Çπ${netWorth.toLocaleString()}`;
            document.getElementById('balanceSheetNetWorth').className = `font-bold text-lg ${netWorth >= 0 ? 'text-blue-600' : 'text-red-600'}`;

            // Add financial analysis section
            updateFinancialAnalysis(analysis);
            
            // Update balance sheet date
            document.getElementById('balanceSheetDate').textContent = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Generate Financial Analysis
        function generateFinancialAnalysis(totalAssets, totalLiabilities, cashBalance, currentAssets, currentLiabilities) {
            const analysis = {
                healthScore: 0,
                insights: [],
                recommendations: [],
                ratios: {}
            };

            // Calculate key financial ratios
            const debtToAssetRatio = totalAssets > 0 ? (totalLiabilities / totalAssets) * 100 : 0;
            const currentRatio = currentLiabilities > 0 ? currentAssets / currentLiabilities : currentAssets > 0 ? 999 : 0;
            const netWorth = totalAssets - totalLiabilities;
            const netWorthRatio = totalAssets > 0 ? (netWorth / totalAssets) * 100 : 0;

            analysis.ratios = {
                debtToAsset: debtToAssetRatio,
                currentRatio: currentRatio,
                netWorthRatio: netWorthRatio
            };

            // Health Score Calculation (0-100)
            let healthScore = 50; // Base score

            // Net Worth Impact (40 points)
            if (netWorth > 0) {
                healthScore += 20;
                if (netWorthRatio > 50) healthScore += 10;
                if (netWorthRatio > 75) healthScore += 10;
            } else {
                healthScore -= 20;
            }

            // Debt Management (30 points)
            if (debtToAssetRatio < 30) healthScore += 15;
            else if (debtToAssetRatio < 50) healthScore += 10;
            else if (debtToAssetRatio < 70) healthScore += 5;
            else healthScore -= 10;

            // Liquidity (30 points)
            if (currentRatio >= 2) healthScore += 15;
            else if (currentRatio >= 1.5) healthScore += 10;
            else if (currentRatio >= 1) healthScore += 5;
            else healthScore -= 15;

            if (cashBalance > 0) healthScore += 15;
            else healthScore -= 15;

            analysis.healthScore = Math.max(0, Math.min(100, healthScore));

            // Generate Insights
            if (netWorth > 0) {
                analysis.insights.push({
                    type: 'positive',
                    icon: '‚úÖ',
                    title: 'Positive Net Worth',
                    description: `Your assets exceed liabilities by ‚Çπ${netWorth.toLocaleString()}. This indicates good financial health.`
                });
            } else {
                analysis.insights.push({
                    type: 'negative',
                    icon: '‚ö†Ô∏è',
                    title: 'Negative Net Worth',
                    description: `Your liabilities exceed assets by ‚Çπ${Math.abs(netWorth).toLocaleString()}. Focus on debt reduction.`
                });
            }

            if (currentRatio >= 2) {
                analysis.insights.push({
                    type: 'positive',
                    icon: 'üíß',
                    title: 'Excellent Liquidity',
                    description: `Current ratio of ${currentRatio.toFixed(2)} indicates strong ability to meet short-term obligations.`
                });
            } else if (currentRatio < 1) {
                analysis.insights.push({
                    type: 'warning',
                    icon: 'üö®',
                    title: 'Liquidity Concern',
                    description: `Current ratio of ${currentRatio.toFixed(2)} suggests difficulty meeting short-term obligations.`
                });
            }

            if (debtToAssetRatio > 70) {
                analysis.insights.push({
                    type: 'negative',
                    icon: 'üìä',
                    title: 'High Debt Burden',
                    description: `${debtToAssetRatio.toFixed(1)}% of assets are financed by debt. Consider debt reduction strategies.`
                });
            } else if (debtToAssetRatio < 30) {
                analysis.insights.push({
                    type: 'positive',
                    icon: 'üéØ',
                    title: 'Conservative Debt Level',
                    description: `Only ${debtToAssetRatio.toFixed(1)}% debt-to-asset ratio indicates conservative financial management.`
                });
            }

            // Generate Recommendations
            if (cashBalance < 0) {
                analysis.recommendations.push({
                    priority: 'high',
                    icon: 'üí∞',
                    title: 'Build Emergency Fund',
                    description: 'Negative cash balance indicates immediate need for emergency savings.',
                    action: 'Aim to save 3-6 months of expenses as emergency fund.'
                });
            } else if (cashBalance < 50000) {
                analysis.recommendations.push({
                    priority: 'medium',
                    icon: 'üè¶',
                    title: 'Increase Cash Reserves',
                    description: 'Low cash balance may limit financial flexibility.',
                    action: 'Consider increasing liquid savings for better financial security.'
                });
            }

            if (debtToAssetRatio > 50) {
                analysis.recommendations.push({
                    priority: 'high',
                    icon: 'üìâ',
                    title: 'Debt Reduction Strategy',
                    description: 'High debt levels may impact financial stability.',
                    action: 'Focus on paying down high-interest debt first using debt avalanche method.'
                });
            }

            if (totalAssets < 500000) {
                analysis.recommendations.push({
                    priority: 'medium',
                    icon: 'üìà',
                    title: 'Asset Building',
                    description: 'Growing your asset base will improve long-term wealth.',
                    action: 'Consider systematic investment in diversified assets like mutual funds or real estate.'
                });
            }

            if (currentRatio < 1.5) {
                analysis.recommendations.push({
                    priority: 'medium',
                    icon: '‚ö°',
                    title: 'Improve Liquidity',
                    description: 'Current ratio below 1.5 may indicate liquidity challenges.',
                    action: 'Maintain higher cash reserves or reduce short-term liabilities.'
                });
            }

            return analysis;
        }

        // Update Financial Analysis Display
        function updateFinancialAnalysis(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            if (!analysisContent) return;

            let healthColor = 'text-red-600';
            let healthBg = 'bg-red-100';
            let healthLabel = 'Poor';

            if (analysis.healthScore >= 80) {
                healthColor = 'text-green-600';
                healthBg = 'bg-green-100';
                healthLabel = 'Excellent';
            } else if (analysis.healthScore >= 60) {
                healthColor = 'text-blue-600';
                healthBg = 'bg-blue-100';
                healthLabel = 'Good';
            } else if (analysis.healthScore >= 40) {
                healthColor = 'text-yellow-600';
                healthBg = 'bg-yellow-100';
                healthLabel = 'Fair';
            }

            let analysisHTML = `
                <!-- Health Score -->
                <div class="flex items-center justify-between p-4 ${healthBg} rounded-lg border-l-4 border-purple-500">
                    <div>
                        <h5 class="font-semibold ${healthColor}">Financial Health Score</h5>
                        <p class="text-sm text-gray-600">Overall assessment of your financial position</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold ${healthColor}">${analysis.healthScore}/100</div>
                        <div class="text-sm font-medium ${healthColor}">${healthLabel}</div>
                    </div>
                </div>

                <!-- Key Ratios -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h6 class="font-medium text-gray-700 mb-1">Debt-to-Asset Ratio</h6>
                        <div class="text-2xl font-bold ${analysis.ratios.debtToAsset > 70 ? 'text-red-600' : analysis.ratios.debtToAsset < 30 ? 'text-green-600' : 'text-yellow-600'}">
                            ${analysis.ratios.debtToAsset.toFixed(1)}%
                        </div>
                        <p class="text-xs text-gray-500">Lower is better</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h6 class="font-medium text-gray-700 mb-1">Current Ratio</h6>
                        <div class="text-2xl font-bold ${analysis.ratios.currentRatio >= 2 ? 'text-green-600' : analysis.ratios.currentRatio >= 1 ? 'text-yellow-600' : 'text-red-600'}">
                            ${analysis.ratios.currentRatio === 999 ? '‚àû' : analysis.ratios.currentRatio.toFixed(2)}
                        </div>
                        <p class="text-xs text-gray-500">Ideal: 1.5-3.0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h6 class="font-medium text-gray-700 mb-1">Net Worth Ratio</h6>
                        <div class="text-2xl font-bold ${analysis.ratios.netWorthRatio > 50 ? 'text-green-600' : analysis.ratios.netWorthRatio > 0 ? 'text-yellow-600' : 'text-red-600'}">
                            ${analysis.ratios.netWorthRatio.toFixed(1)}%
                        </div>
                        <p class="text-xs text-gray-500">Higher is better</p>
                    </div>
                </div>
            `;

            // Add insights
            if (analysis.insights.length > 0) {
                analysisHTML += `
                    <div>
                        <h5 class="font-semibold text-gray-700 mb-3">Key Insights</h5>
                        <div class="space-y-3">
                `;
                
                analysis.insights.forEach(insight => {
                    const bgColor = insight.type === 'positive' ? 'bg-green-50 border-green-200' : 
                                   insight.type === 'negative' ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200';
                    
                    analysisHTML += `
                        <div class="p-3 rounded-lg border ${bgColor}">
                            <div class="flex items-start space-x-3">
                                <span class="text-lg">${insight.icon}</span>
                                <div>
                                    <h6 class="font-medium text-gray-800">${insight.title}</h6>
                                    <p class="text-sm text-gray-600">${insight.description}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                analysisHTML += `
                        </div>
                    </div>
                `;
            }

            // Add recommendations
            if (analysis.recommendations.length > 0) {
                analysisHTML += `
                    <div>
                        <h5 class="font-semibold text-gray-700 mb-3">Recommendations</h5>
                        <div class="space-y-3">
                `;
                
                analysis.recommendations.forEach(rec => {
                    const priorityColor = rec.priority === 'high' ? 'border-red-400 bg-red-50' : 
                                         rec.priority === 'medium' ? 'border-yellow-400 bg-yellow-50' : 'border-blue-400 bg-blue-50';
                    const priorityBadge = rec.priority === 'high' ? 'bg-red-100 text-red-800' : 
                                         rec.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800';
                    
                    analysisHTML += `
                        <div class="p-4 rounded-lg border-l-4 ${priorityColor}">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-3 flex-1">
                                    <span class="text-lg">${rec.icon}</span>
                                    <div>
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h6 class="font-medium text-gray-800">${rec.title}</h6>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full ${priorityBadge}">
                                                ${rec.priority.toUpperCase()}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2">${rec.description}</p>
                                        <p class="text-sm font-medium text-gray-800">üí° ${rec.action}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                analysisHTML += `
                        </div>
                    </div>
                `;
            }

            analysisContent.innerHTML = analysisHTML;
        }

        // Professional Income Statement - CA Format
        function updateIncomeStatement() {
            // Get account balances for professional P&L
            const incomeAccount = financeData.accounts.find(acc => acc.id === 'income');
            const interestIncomeAccount = financeData.accounts.find(acc => acc.id === 'interest_income');
            const expenseAccount = financeData.accounts.find(acc => acc.id === 'expenses');
            const interestExpenseAccount = financeData.accounts.find(acc => acc.id === 'interest_expense');
            
            // Calculate total revenue
            const operatingIncome = incomeAccount.balance;
            const interestIncome = interestIncomeAccount.balance;
            const totalRevenue = operatingIncome + interestIncome;
            
            // Calculate total expenses
            const operatingExpenses = expenseAccount.balance;
            const interestExpenses = interestExpenseAccount.balance;
            const totalExpenses = operatingExpenses + interestExpenses;
            
            // Calculate net income
            const grossProfit = operatingIncome - operatingExpenses;
            const netIncome = totalRevenue - totalExpenses;

            // Update display with professional format
            document.getElementById('totalRevenue').innerHTML = `
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-sm">Operating Income:</span>
                        <span class="text-sm">‚Çπ${operatingIncome.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Interest Income:</span>
                        <span class="text-sm">‚Çπ${interestIncome.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between font-semibold border-t pt-1">
                        <span>Total Revenue:</span>
                        <span class="text-green-600">‚Çπ${totalRevenue.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('totalExpensesReport').innerHTML = `
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-sm">Operating Expenses:</span>
                        <span class="text-sm">‚Çπ${operatingExpenses.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Interest Expenses:</span>
                        <span class="text-sm">‚Çπ${interestExpenses.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between font-semibold border-t pt-1">
                        <span>Total Expenses:</span>
                        <span class="text-red-600">‚Çπ${totalExpenses.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('netIncome').textContent = `‚Çπ${netIncome.toLocaleString()}`;
            document.getElementById('netIncome').className = `font-bold text-lg ${netIncome >= 0 ? 'text-green-600' : 'text-red-600'}`;

            // Professional expense breakdown
            const categoryBreakdown = {};
            financeData.transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    categoryBreakdown[t.category] = (categoryBreakdown[t.category] || 0) + t.amount;
                });

            const expenseBreakdown = document.getElementById('expenseBreakdown');
            if (Object.keys(categoryBreakdown).length === 0) {
                expenseBreakdown.innerHTML = '<p class="text-gray-500 text-sm">No operating expenses recorded</p>';
            } else {
                let breakdownHTML = `
                    <div class="mb-3">
                        <h5 class="font-semibold text-gray-700 mb-2">Operating Expenses by Category:</h5>
                `;
                
                Object.entries(categoryBreakdown).forEach(([category, amount]) => {
                    const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
                    breakdownHTML += `
                        <div class="flex justify-between py-1 border-b border-gray-100">
                            <span class="text-sm">${category}</span>
                            <div class="text-right">
                                <span class="text-sm font-medium">‚Çπ${amount.toLocaleString()}</span>
                                <span class="text-xs text-gray-500 ml-2">(${percentage}%)</span>
                            </div>
                        </div>
                    `;
                });
                
                if (interestExpenses > 0) {
                    const interestPercentage = totalExpenses > 0 ? ((interestExpenses / totalExpenses) * 100).toFixed(1) : 0;
                    breakdownHTML += `
                        <div class="flex justify-between py-1 border-b border-gray-100 bg-red-50">
                            <span class="text-sm font-medium">Interest Expenses</span>
                            <div class="text-right">
                                <span class="text-sm font-medium text-red-600">‚Çπ${interestExpenses.toLocaleString()}</span>
                                <span class="text-xs text-gray-500 ml-2">(${interestPercentage}%)</span>
                            </div>
                        </div>
                    `;
                }
                
                breakdownHTML += '</div>';
                expenseBreakdown.innerHTML = breakdownHTML;
            }
        }

        // Update Cash Flow Statement
        function updateCashFlowStatement() {
            const income = financeData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = financeData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const loansReceived = financeData.loans
                .filter(l => l.type === 'received')
                .reduce((sum, l) => sum + l.amount, 0);
            
            const loansGiven = financeData.loans
                .filter(l => l.type === 'given')
                .reduce((sum, l) => sum + l.amount, 0);

            const netOperatingCashFlow = income - expenses;
            const netFinancingCashFlow = loansReceived - loansGiven;
            const netCashFlow = netOperatingCashFlow + netFinancingCashFlow;

            document.getElementById('cashFromIncome').textContent = `‚Çπ${income.toLocaleString()}`;
            document.getElementById('cashForExpenses').textContent = `‚Çπ${expenses.toLocaleString()}`;
            document.getElementById('netOperatingCashFlow').textContent = `‚Çπ${netOperatingCashFlow.toLocaleString()}`;
            document.getElementById('netOperatingCashFlow').className = `font-semibold ${netOperatingCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`;

            document.getElementById('cashFromLoans').textContent = `‚Çπ${loansReceived.toLocaleString()}`;
            document.getElementById('cashForLoans').textContent = `‚Çπ${loansGiven.toLocaleString()}`;
            document.getElementById('netFinancingCashFlow').textContent = `‚Çπ${netFinancingCashFlow.toLocaleString()}`;
            document.getElementById('netFinancingCashFlow').className = `font-semibold ${netFinancingCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`;

            document.getElementById('netCashFlow').textContent = `‚Çπ${netCashFlow.toLocaleString()}`;
            document.getElementById('netCashFlow').className = `font-bold text-lg ${netCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }

        // Update Streak
        function updateStreak() {
            const today = new Date().toDateString();
            const lastActivity = financeData.lastActivity;
            
            if (!lastActivity) {
                financeData.streak = 1;
            } else {
                const lastDate = new Date(lastActivity).toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastDate === today) {
                    // Already tracked today, don't increment
                } else if (lastDate === yesterday.toDateString()) {
                    // Consecutive day
                    financeData.streak += 1;
                } else {
                    // Streak broken
                    financeData.streak = 1;
                }
            }
            
            financeData.lastActivity = today;
            document.getElementById('currentStreak').textContent = `${financeData.streak} days`;
            saveData();
        }

        // Check Achievements
        function checkAchievements() {
            const achievements = [
                { id: 'first_transaction', name: 'First Step', description: 'Added your first transaction', icon: 'üéØ', condition: () => financeData.transactions.length >= 1 },
                { id: 'week_streak', name: 'Week Warrior', description: '7 day tracking streak', icon: 'üî•', condition: () => financeData.streak >= 7 },
                { id: 'month_streak', name: 'Monthly Master', description: '30 day tracking streak', icon: 'üëë', condition: () => financeData.streak >= 30 },
                { id: 'first_goal', name: 'Goal Setter', description: 'Created your first goal', icon: 'üéØ', condition: () => financeData.goals.length >= 1 },
                { id: 'goal_achieved', name: 'Goal Crusher', description: 'Completed a savings goal', icon: 'üèÜ', condition: () => financeData.goals.some(g => g.current >= g.target) },
                { id: 'budget_master', name: 'Budget Master', description: 'Set 5 different budgets', icon: 'üí∞', condition: () => financeData.budgets.length >= 5 },
                { id: 'loan_manager', name: 'Loan Manager', description: 'Recorded your first loan', icon: 'üè¶', condition: () => financeData.loans.length >= 1 },
                { id: 'analyst', name: 'Financial Analyst', description: 'Used all report features', icon: 'üìä', condition: () => financeData.transactions.some(t => t.type === 'asset') && financeData.transactions.some(t => t.type === 'liability') },
                { id: 'saver', name: 'Smart Saver', description: 'Maintained 20% savings rate', icon: 'üíé', condition: () => {
                    const income = financeData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const expenses = financeData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    return income > 0 && ((income - expenses) / income) >= 0.2;
                }}
            ];

            achievements.forEach(achievement => {
                if (achievement.condition() && !financeData.achievements.includes(achievement.id)) {
                    financeData.achievements.push(achievement.id);
                    showNotification(`üèÜ Achievement Unlocked: ${achievement.name}!`, 'success');
                }
            });

            updateAchievements();
            saveData();
        }

        // Update Achievements Display
        function updateAchievements() {
            const badgesList = document.getElementById('badgesList');
            
            const achievements = [
                { id: 'first_transaction', name: 'First Step', description: 'Added your first transaction', icon: 'üéØ' },
                { id: 'week_streak', name: 'Week Warrior', description: '7 day tracking streak', icon: 'üî•' },
                { id: 'month_streak', name: 'Monthly Master', description: '30 day tracking streak', icon: 'üëë' },
                { id: 'first_goal', name: 'Goal Setter', description: 'Created your first goal', icon: 'üéØ' },
                { id: 'goal_achieved', name: 'Goal Crusher', description: 'Completed a savings goal', icon: 'üèÜ' },
                { id: 'budget_master', name: 'Budget Master', description: 'Set 5 different budgets', icon: 'üí∞' },
                { id: 'loan_manager', name: 'Loan Manager', description: 'Recorded your first loan', icon: 'üè¶' },
                { id: 'analyst', name: 'Financial Analyst', description: 'Used all report features', icon: 'üìä' },
                { id: 'saver', name: 'Smart Saver', description: 'Maintained 20% savings rate', icon: 'üíé' }
            ];

            badgesList.innerHTML = achievements.map(achievement => {
                const earned = financeData.achievements.includes(achievement.id);
                return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center ${earned ? 'badge-pulse' : 'opacity-50'}">
                        <div class="text-4xl mb-3">${achievement.icon}</div>
                        <h3 class="font-semibold text-gray-800 mb-2">${achievement.name}</h3>
                        <p class="text-sm text-gray-600">${achievement.description}</p>
                        ${earned ? '<div class="mt-3 text-green-600 font-medium">‚úì Earned</div>' : '<div class="mt-3 text-gray-400">Not earned yet</div>'}
                    </div>
                `;
            }).join('');
        }

        // Export Transactions to PDF
        function exportTransactionsToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.text('FinanceFlow Pro by GrowEase', 20, 20);
            doc.setFontSize(16);
            doc.text('Transaction Report', 20, 35);
            
            // Summary
            const income = financeData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = financeData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;
            
            doc.setFontSize(12);
            doc.text(`Report Generated: ${new Date().toLocaleDateString()}`, 20, 50);
            doc.text(`Total Transactions: ${financeData.transactions.length}`, 20, 60);
            doc.text(`Total Income: ‚Çπ${income.toLocaleString()}`, 20, 70);
            doc.text(`Total Expenses: ‚Çπ${expenses.toLocaleString()}`, 20, 80);
            doc.text(`Net Balance: ‚Çπ${balance.toLocaleString()}`, 20, 90);
            
            // Transactions table
            doc.text('Transaction Details:', 20, 110);
            let yPos = 125;
            
            // Table headers
            doc.setFontSize(10);
            doc.text('Date', 20, yPos);
            doc.text('Type', 50, yPos);
            doc.text('Description', 80, yPos);
            doc.text('Category', 130, yPos);
            doc.text('Amount', 170, yPos);
            yPos += 5;
            
            // Draw line under headers
            doc.line(20, yPos, 190, yPos);
            yPos += 10;
            
            // Transaction rows
            financeData.transactions.forEach((transaction, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                    // Add header on new page
                    doc.setFontSize(12);
                    doc.text('FinanceFlow Pro by GrowEase - Transaction Report (Continued)', 20, yPos);
                    yPos += 20;
                    doc.setFontSize(10);
                }
                
                doc.text(transaction.date, 20, yPos);
                doc.text(transaction.type, 50, yPos);
                doc.text(transaction.description.substring(0, 25), 80, yPos);
                doc.text(transaction.category, 130, yPos);
                doc.text(`${getAmountPrefix(transaction.type)}‚Çπ${transaction.amount.toLocaleString()}`, 170, yPos);
                yPos += 8;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount} | Generated by FinanceFlow Pro by GrowEase`, 20, 290);
            }
            
            doc.save(`transactions-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Transaction PDF report downloaded!', 'success');
        }

        // Export Transactions to Excel
        function exportTransactionsToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Prepare transaction data
            const transactionsData = financeData.transactions.map(t => ({
                Date: t.date,
                Type: t.type.charAt(0).toUpperCase() + t.type.slice(1),
                Amount: t.amount,
                Description: t.description,
                Category: t.category,
                'Amount with Sign': `${getAmountPrefix(t.type)}‚Çπ${t.amount.toLocaleString()}`
            }));
            
            // Add summary data
            const income = financeData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = financeData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;
            
            const summaryData = [
                { Metric: 'Total Income', Value: `‚Çπ${income.toLocaleString()}` },
                { Metric: 'Total Expenses', Value: `‚Çπ${expenses.toLocaleString()}` },
                { Metric: 'Net Balance', Value: `‚Çπ${balance.toLocaleString()}` },
                { Metric: 'Total Transactions', Value: financeData.transactions.length },
                { Metric: 'Report Generated', Value: new Date().toLocaleDateString() },
                { Metric: 'Generated By', Value: 'FinanceFlow Pro by GrowEase' }
            ];
            
            // Create worksheets
            const ws1 = XLSX.utils.json_to_sheet(transactionsData);
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            
            // Add worksheets to workbook
            XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
            XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
            
            // Save file
            XLSX.writeFile(wb, `transactions-report-${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Transaction Excel report downloaded!', 'success');
        }

        // Export to PDF
        function exportToPDF(type = 'complete') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Company branding colors
            const primaryColor = [16, 185, 129]; // Green
            const secondaryColor = [59, 130, 246]; // Blue
            const accentColor = [139, 92, 246]; // Purple
            
            // Header with company branding
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            // Company logo area (using text as logo)
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('FinanceFlow Pro', 20, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('by GrowEase Technologies', 20, 28);
            
            // Report title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            const reportTitle = type === 'complete' ? 'Complete Financial Report' : 'Balance Sheet Report';
            doc.text(reportTitle, 20, 36);
            
            // Reset text color for body
            doc.setTextColor(0, 0, 0);
            
            if (type === 'complete') {
                // Executive Summary Section
                doc.setFillColor(248, 250, 252);
                doc.rect(15, 50, 180, 60, 'F');
                doc.setDrawColor(226, 232, 240);
                doc.rect(15, 50, 180, 60, 'S');
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...secondaryColor);
                doc.text('EXECUTIVE SUMMARY', 20, 60);
                
                // Calculate key metrics
                const income = financeData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = financeData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const assets = financeData.transactions.filter(t => t.type === 'asset').reduce((sum, t) => sum + t.amount, 0);
                const liabilities = financeData.transactions.filter(t => t.type === 'liability').reduce((sum, t) => sum + t.amount, 0);
                const balance = income - expenses;
                const netWorth = assets - liabilities + balance;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                doc.text(`Report Generated: ${reportDate}`, 20, 70);
                doc.text(`Reporting Period: All Time`, 20, 76);
                doc.text(`Total Transactions Analyzed: ${financeData.transactions.length}`, 20, 82);
                
                // Key metrics in two columns
                doc.setFont('helvetica', 'bold');
                doc.text('FINANCIAL POSITION', 20, 92);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total Income: ‚Çπ${income.toLocaleString()}`, 25, 98);
                doc.text(`Total Expenses: ‚Çπ${expenses.toLocaleString()}`, 25, 104);
                
                doc.setFont('helvetica', 'bold');
                doc.text('NET WORTH ANALYSIS', 110, 92);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total Assets: ‚Çπ${assets.toLocaleString()}`, 115, 98);
                doc.text(`Total Liabilities: ‚Çπ${liabilities.toLocaleString()}`, 115, 104);
                
                // Net worth highlight
                doc.setFillColor(netWorth >= 0 ? 34 : 239, netWorth >= 0 ? 197 : 68, netWorth >= 0 ? 94 : 68);
                doc.rect(15, 115, 180, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`NET WORTH: ‚Çπ${netWorth.toLocaleString()}`, 20, 125);
                doc.text(`CASH BALANCE: ‚Çπ${balance.toLocaleString()}`, 110, 125);
                
                // Financial Health Analysis
                const currentAssets = Math.max(0, balance);
                const currentLiabilities = Math.max(0, -balance);
                const analysis = generateFinancialAnalysis(assets, liabilities, balance, currentAssets, currentLiabilities);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...accentColor);
                doc.text('FINANCIAL HEALTH ANALYSIS', 20, 145);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                let yPos = 155;
                doc.text(`Financial Health Score: ${analysis.healthScore}/100`, 20, yPos);
                yPos += 8;
                
                // Key ratios
                doc.setFont('helvetica', 'bold');
                doc.text('Key Financial Ratios:', 20, yPos);
                yPos += 8;
                doc.setFont('helvetica', 'normal');
                doc.text(`‚Ä¢ Debt-to-Asset Ratio: ${analysis.ratios.debtToAsset.toFixed(1)}%`, 25, yPos);
                yPos += 6;
                doc.text(`‚Ä¢ Current Ratio: ${analysis.ratios.currentRatio === 999 ? '‚àû' : analysis.ratios.currentRatio.toFixed(2)}`, 25, yPos);
                yPos += 6;
                doc.text(`‚Ä¢ Net Worth Ratio: ${analysis.ratios.netWorthRatio.toFixed(1)}%`, 25, yPos);
                yPos += 10;
                
                // Top recommendations
                if (analysis.recommendations.length > 0) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Priority Recommendations:', 20, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    
                    analysis.recommendations.slice(0, 3).forEach(rec => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(`‚Ä¢ ${rec.title}: ${rec.action}`, 25, yPos);
                        yPos += 6;
                    });
                }
                
                // Transaction Details (New Page)
                doc.addPage();
                
                // Header for new page
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('TRANSACTION DETAILS', 20, 16);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Recent Transactions (Last 25)', 20, 40);
                
                // Transaction table headers
                yPos = 50;
                doc.setFillColor(240, 240, 240);
                doc.rect(15, yPos - 5, 180, 10, 'F');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('Date', 20, yPos);
                doc.text('Type', 45, yPos);
                doc.text('Description', 70, yPos);
                doc.text('Category', 130, yPos);
                doc.text('Amount', 165, yPos);
                yPos += 10;
                
                // Transaction rows
                doc.setFont('helvetica', 'normal');
                financeData.transactions.slice(0, 25).forEach((transaction, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        // Add header to new page
                        doc.setFillColor(...primaryColor);
                        doc.rect(0, 0, 210, 20, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(14);
                        doc.text('TRANSACTION DETAILS (Continued)', 20, 13);
                        doc.setTextColor(0, 0, 0);
                        yPos = 30;
                    }
                    
                    // Alternate row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 250, 252);
                        doc.rect(15, yPos - 4, 180, 8, 'F');
                    }
                    
                    doc.text(transaction.date, 20, yPos);
                    doc.text(transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1), 45, yPos);
                    doc.text(transaction.description.substring(0, 25), 70, yPos);
                    doc.text(transaction.category, 130, yPos);
                    
                    // Color-code amounts
                    const amountColor = transaction.type === 'income' || transaction.type === 'asset' ? [34, 197, 94] : [239, 68, 68];
                    doc.setTextColor(...amountColor);
                    doc.text(`${getAmountPrefix(transaction.type)}‚Çπ${transaction.amount.toLocaleString()}`, 165, yPos);
                    doc.setTextColor(0, 0, 0);
                    
                    yPos += 8;
                });

                // Loan Records (if any)
                if (financeData.loans.length > 0) {
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, 210, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LOAN PORTFOLIO', 20, 16);
                    
                    doc.setTextColor(0, 0, 0);
                    yPos = 40;
                    
                    financeData.loans.forEach((loan, index) => {
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 30;
                        }
                        
                        // Loan card background
                        doc.setFillColor(loan.type === 'given' ? 220 : 254, loan.type === 'given' ? 252 : 226, loan.type === 'given' ? 231 : 220);
                        doc.rect(15, yPos - 5, 180, 25, 'F');
                        doc.setDrawColor(loan.type === 'given' ? 34 : 239, loan.type === 'given' ? 197 : 68, loan.type === 'given' ? 94 : 68);
                        doc.rect(15, yPos - 5, 180, 25, 'S');
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${loan.person} - ${loan.type.toUpperCase()}`, 20, yPos);
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Amount: ‚Çπ${loan.amount.toLocaleString()}`, 20, yPos + 6);
                        doc.text(`Interest: ${loan.interest}%`, 20, yPos + 12);
                        doc.text(`Due Date: ${loan.dueDate}`, 100, yPos + 6);
                        doc.text(`Status: ${loan.status.toUpperCase()}`, 100, yPos + 12);
                        
                        yPos += 35;
                    });
                }
                
            } else if (type === 'balance-sheet') {
                // Professional Balance Sheet Layout
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...secondaryColor);
                doc.text('BALANCE SHEET', 20, 55);
                doc.text(`As of ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 65);
                
                const assets = financeData.transactions.filter(t => t.type === 'asset');
                const liabilities = financeData.transactions.filter(t => t.type === 'liability');
                const income = financeData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = financeData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const cashBalance = income - expenses;
                
                const totalFixedAssets = assets.reduce((sum, t) => sum + t.amount, 0);
                const totalCurrentAssets = Math.max(0, cashBalance);
                const totalAssets = totalFixedAssets + totalCurrentAssets;
                
                const totalLiabilities = liabilities.reduce((sum, t) => sum + t.amount, 0);
                const netWorth = totalAssets - totalLiabilities;
                
                let yPos = 80;
                
                // Assets Section
                doc.setFillColor(220, 252, 231);
                doc.rect(15, yPos, 85, 15, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('ASSETS', 20, yPos + 10);
                yPos += 20;
                
                // Current Assets
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Current Assets:', 20, yPos);
                yPos += 8;
                doc.setFont('helvetica', 'normal');
                if (cashBalance > 0) {
                    doc.text(`Cash & Bank Balance`, 25, yPos);
                    doc.text(`‚Çπ${cashBalance.toLocaleString()}`, 80, yPos);
                    yPos += 6;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Total Current Assets:', 25, yPos);
                doc.text(`‚Çπ${totalCurrentAssets.toLocaleString()}`, 80, yPos);
                yPos += 12;
                
                // Non-Current Assets
                if (assets.length > 0) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Non-Current Assets:', 20, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    assets.forEach(asset => {
                        doc.text(asset.description, 25, yPos);
                        doc.text(`‚Çπ${asset.amount.toLocaleString()}`, 80, yPos);
                        yPos += 6;
                    });
                    doc.setFont('helvetica', 'bold');
                    doc.text('Total Non-Current Assets:', 25, yPos);
                    doc.text(`‚Çπ${totalFixedAssets.toLocaleString()}`, 80, yPos);
                    yPos += 12;
                }
                
                // Total Assets
                doc.setFillColor(34, 197, 94);
                doc.rect(15, yPos, 85, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL ASSETS:', 20, yPos + 7);
                doc.text(`‚Çπ${totalAssets.toLocaleString()}`, 80, yPos + 7);
                
                // Liabilities & Equity Section (Right side)
                yPos = 95;
                doc.setFillColor(254, 226, 226);
                doc.rect(110, yPos, 85, 15, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LIABILITIES & EQUITY', 115, yPos + 10);
                yPos += 20;
                
                // Liabilities
                if (liabilities.length > 0) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Liabilities:', 115, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    liabilities.forEach(liability => {
                        doc.text(liability.description, 120, yPos);
                        doc.text(`‚Çπ${liability.amount.toLocaleString()}`, 175, yPos);
                        yPos += 6;
                    });
                    doc.setFont('helvetica', 'bold');
                    doc.text('Total Liabilities:', 120, yPos);
                    doc.text(`‚Çπ${totalLiabilities.toLocaleString()}`, 175, yPos);
                    yPos += 12;
                }
                
                // Equity (Net Worth)
                doc.setFillColor(59, 130, 246);
                doc.rect(110, yPos, 85, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('NET WORTH (EQUITY):', 115, yPos + 7);
                doc.text(`‚Çπ${netWorth.toLocaleString()}`, 175, yPos + 7);
            }
            
            // Professional footer for all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // Footer background
                doc.setFillColor(248, 250, 252);
                doc.rect(0, 285, 210, 12, 'F');
                
                doc.setTextColor(107, 114, 128);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generated by FinanceFlow Pro by GrowEase Technologies | ${new Date().toLocaleDateString()}`, 20, 292);
                doc.text(`Page ${i} of ${pageCount}`, 170, 292);
                
                // Confidentiality notice
                doc.setFontSize(7);
                doc.text('CONFIDENTIAL - This report contains sensitive financial information', 20, 296);
            }
            
            doc.save(`financeflow-${type}-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Professional PDF report downloaded successfully!', 'success');
        }

        // Export to Excel
        function exportToExcel(type = 'all') {
            const wb = XLSX.utils.book_new();
            
            if (type === 'all') {
                // Transactions sheet
                const transactionsData = financeData.transactions.map(t => ({
                    Date: t.date,
                    Type: t.type,
                    Amount: t.amount,
                    Description: t.description,
                    Category: t.category
                }));
                
                const ws1 = XLSX.utils.json_to_sheet(transactionsData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
                
                // Budgets sheet
                const budgetsData = financeData.budgets.map(b => ({
                    Category: b.category,
                    Budget: b.amount,
                    Spent: b.spent,
                    Remaining: b.amount - b.spent
                }));
                
                const ws2 = XLSX.utils.json_to_sheet(budgetsData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Budgets');
                
                // Goals sheet
                const goalsData = financeData.goals.map(g => ({
                    Goal: g.name,
                    Target: g.target,
                    Current: g.current,
                    Progress: `${((g.current / g.target) * 100).toFixed(1)}%`,
                    Deadline: g.deadline
                }));
                
                const ws3 = XLSX.utils.json_to_sheet(goalsData);
                XLSX.utils.book_append_sheet(wb, ws3, 'Goals');

                // Loans sheet
                const loansData = financeData.loans.map(l => ({
                    Person: l.person,
                    Type: l.type,
                    Amount: l.amount,
                    Interest: l.interest + '%',
                    DueDate: l.dueDate,
                    Status: l.status
                }));
                
                const ws4 = XLSX.utils.json_to_sheet(loansData);
                XLSX.utils.book_append_sheet(wb, ws4, 'Loans');
                
                XLSX.writeFile(wb, `finance-data-complete-${new Date().toISOString().split('T')[0]}.xlsx`);
            } else if (type === 'transactions') {
                const transactionsData = financeData.transactions.map(t => ({
                    Date: t.date,
                    Type: t.type,
                    Amount: t.amount,
                    Description: t.description,
                    Category: t.category
                }));
                
                const ws = XLSX.utils.json_to_sheet(transactionsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
                
                XLSX.writeFile(wb, `transactions-data-${new Date().toISOString().split('T')[0]}.xlsx`);
            }
            
            showNotification('Excel file downloaded successfully!', 'success');
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification p-4 rounded-lg shadow-lg text-white max-w-sm ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Check Daily Notifications
        function checkDailyNotifications() {
            const today = new Date().toISOString().split('T')[0];
            
            // Check for loan reminders
            financeData.notifications.forEach(notification => {
                if (notification.reminderDate === today && notification.status === 'scheduled') {
                    showPersistentNotification(notification);
                    notification.status = 'shown';
                }
            });
            
            // Check for overdue loans
            const overdueLoans = financeData.loans.filter(loan => {
                const daysUntilDue = Math.ceil((new Date(loan.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                return daysUntilDue < 0 && loan.status === 'active';
            });
            
            // Check for due soon loans
            const dueSoonLoans = financeData.loans.filter(loan => {
                const daysUntilDue = Math.ceil((new Date(loan.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                return daysUntilDue <= 7 && daysUntilDue >= 0 && loan.status === 'active';
            });
            
            if (overdueLoans.length > 0) {
                showPersistentNotification({
                    title: '‚ö†Ô∏è Overdue Loans',
                    message: `You have ${overdueLoans.length} overdue loan(s) that need attention!`,
                    type: 'error'
                });
            } else if (dueSoonLoans.length > 0) {
                showPersistentNotification({
                    title: '‚è∞ Upcoming Payments',
                    message: `${dueSoonLoans.length} loan payment(s) due within 7 days`,
                    type: 'warning'
                });
            }
            
            saveData();
        }

        // Show Persistent Notification
        function showPersistentNotification(notification) {
            if (!financeData.settings.enableNotifications) return;
            
            // Play notification sound
            if (financeData.settings.notificationSound) {
                playNotificationSound();
            }
            
            // Create persistent notification element
            const notificationEl = document.createElement('div');
            notificationEl.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg border-l-4 ${
                notification.type === 'error' ? 'bg-red-50 border-red-500 text-red-800' :
                notification.type === 'warning' ? 'bg-yellow-50 border-yellow-500 text-yellow-800' :
                'bg-blue-50 border-blue-500 text-blue-800'
            }`;
            
            notificationEl.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold mb-1">${notification.title}</h4>
                        <p class="text-sm">${notification.message}</p>
                        ${notification.dueDate ? `<p class="text-xs mt-1 opacity-75">Due: ${notification.dueDate}</p>` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notificationEl);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notificationEl.parentElement) {
                    notificationEl.remove();
                }
            }, 10000);
        }

        // Play Notification Sound
        function playNotificationSound() {
            // Create a simple beep sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // Settings Functions
        function updateSettings() {
            const enableNotifications = document.getElementById('enableNotifications');
            const notificationSound = document.getElementById('notificationSound');
            
            if (enableNotifications) {
                enableNotifications.checked = financeData.settings.enableNotifications;
                enableNotifications.addEventListener('change', function() {
                    financeData.settings.enableNotifications = this.checked;
                    saveData();
                    showNotification('Notification settings updated', 'success');
                });
            }
            
            if (notificationSound) {
                notificationSound.checked = financeData.settings.notificationSound;
                notificationSound.addEventListener('change', function() {
                    financeData.settings.notificationSound = this.checked;
                    saveData();
                    showNotification('Sound settings updated', 'success');
                });
            }
            
            // Update app info
            document.getElementById('totalTransactionsCount').textContent = financeData.transactions.length;
            document.getElementById('activeLoansCount').textContent = financeData.loans.filter(l => l.status === 'active').length;
            
            const dataSize = new Blob([JSON.stringify(financeData)]).size;
            document.getElementById('dataSize').textContent = (dataSize / 1024).toFixed(1) + ' KB';
        }

        // Backup Data
        function backupData() {
            const dataStr = JSON.stringify(financeData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `financeflow-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Data backup downloaded successfully!', 'success');
        }

        // Restore Data
        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (restoredData.transactions && Array.isArray(restoredData.transactions)) {
                        if (confirm('This will replace all your current data. Are you sure you want to restore from backup?')) {
                            financeData = { ...financeData, ...restoredData };
                            saveData();
                            
                            // Refresh all displays
                            updateDashboard();
                            updateBudgetDisplay();
                            updateGoalsDisplay();
                            updateLoansDisplay();
                            updateReports();
                            updateCharts();
                            updateAchievements();
                            updateSettings();
                            
                            showNotification('Data restored successfully!', 'success');
                        }
                    } else {
                        showNotification('Invalid backup file format', 'error');
                    }
                } catch (error) {
                    showNotification('Error reading backup file', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Clear All Data
        function clearAllData() {
            const confirmation = prompt('This will permanently delete ALL your data. Type "DELETE" to confirm:');
            if (confirmation === 'DELETE') {
                financeData = {
                    transactions: [],
                    budgets: [],
                    goals: [],
                    loans: [],
                    achievements: [],
                    streak: 0,
                    lastActivity: null,
                    notifications: [],
                    settings: {
                        enableNotifications: true,
                        notificationSound: true
                    }
                };
                
                localStorage.removeItem('financeFlowProData');
                
                // Refresh all displays
                updateDashboard();
                updateBudgetDisplay();
                updateGoalsDisplay();
                updateLoansDisplay();
                updateReports();
                updateCharts();
                updateAchievements();
                updateSettings();
                
                showNotification('All data has been cleared', 'success');
            } else if (confirmation !== null) {
                showNotification('Data clearing cancelled - incorrect confirmation', 'error');
            }
        }

        // Add form interaction handlers
        function setupFormInteractions() {
            // Payment frequency change handler
            document.getElementById('loanPaymentFreq').addEventListener('change', function() {
                const installmentFields = [
                    document.getElementById('loanInstallments'),
                    document.getElementById('loanInstallmentAmount')
                ];
                
                if (this.value === 'one-time') {
                    installmentFields.forEach(field => field.classList.add('hidden'));
                } else {
                    installmentFields.forEach(field => field.classList.remove('hidden'));
                }
            });
            
            // Reminder checkbox handler
            document.getElementById('loanReminder').addEventListener('change', function() {
                const reminderDays = document.getElementById('loanReminderDays');
                if (this.checked) {
                    reminderDays.classList.remove('hidden');
                } else {
                    reminderDays.classList.add('hidden');
                }
            });
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdmaW5hbmNlZmxvdy1wcm8tdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLycsICcvaW5kZXguaHRtbCcsICcvbWFuaWZlc3QuanNvbicKXTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGV2ZW50ID0+IHsKICBldmVudC53YWl0VW50aWwoY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkudGhlbihjYWNoZSA9PiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpKSk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aChjYWNoZXMubWF0Y2goZXZlbnQucmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KSkpOwp9KTs=')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        // Enhanced Form Interactions and Keyboard Shortcuts
        function setupEnhancedFormInteractions() {
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Quick entry shortcuts (Ctrl/Cmd + key)
                if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
                    switch(e.key.toLowerCase()) {
                        case 'i':
                            e.preventDefault();
                            showQuickEntry('income');
                            break;
                        case 'e':
                            e.preventDefault();
                            showQuickEntry('expense');
                            break;
                        case 'a':
                            e.preventDefault();
                            showQuickEntry('asset');
                            break;
                        case 'l':
                            e.preventDefault();
                            showQuickEntry('liability');
                            break;
                    }
                }
                
                // Form navigation shortcuts
                if (e.key === 'Escape') {
                    const form = document.getElementById('transactionForm');
                    if (!form.classList.contains('hidden')) {
                        hideTransactionForm();
                    }
                }
                
                // Submit form with Ctrl/Cmd + Enter
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const form = document.getElementById('transactionForm');
                    if (!form.classList.contains('hidden')) {
                        e.preventDefault();
                        addTransaction();
                    }
                }
            });
            
            // Amount field enhancements
            const amountField = document.getElementById('transactionAmount');
            if (amountField) {
                // Format number as user types
                amountField.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^\d.]/g, '');
                    if (value.split('.').length > 2) {
                        value = value.substring(0, value.lastIndexOf('.'));
                    }
                    e.target.value = value;
                });
                
                // Auto-focus next field on Enter
                amountField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('transactionDescription').focus();
                    }
                });
            }
            
            // Description field enhancements
            const descriptionField = document.getElementById('transactionDescription');
            if (descriptionField) {
                // Auto-capitalize first letter
                descriptionField.addEventListener('input', function(e) {
                    if (e.target.value.length === 1) {
                        e.target.value = e.target.value.toUpperCase();
                    }
                });
                
                // Auto-focus category on Enter
                descriptionField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Focus first category button
                        const firstCategory = document.querySelector('.category-btn');
                        if (firstCategory) {
                            firstCategory.focus();
                        }
                    }
                });
            }
            
            // Category keyboard navigation
            document.addEventListener('keydown', function(e) {
                const focusedElement = document.activeElement;
                if (focusedElement && focusedElement.classList.contains('category-btn')) {
                    let nextElement = null;
                    
                    switch(e.key) {
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            nextElement = focusedElement.nextElementSibling;
                            break;
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            nextElement = focusedElement.previousElementSibling;
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            focusedElement.click();
                            return;
                    }
                    
                    if (nextElement && nextElement.classList.contains('category-btn')) {
                        nextElement.focus();
                    }
                }
            });
            
            // Mobile-specific enhancements
            if (window.innerWidth <= 768) {
                // Prevent zoom on input focus for iOS
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        if (input.type === 'number') {
                            input.setAttribute('inputmode', 'decimal');
                        }
                    });
                });
                
                // Add haptic feedback for mobile (if supported)
                if ('vibrate' in navigator) {
                    document.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', function() {
                            navigator.vibrate(10); // Short vibration
                        });
                    });
                }
            }
        }

        // Add helpful tooltips and hints
        function addFormHints() {
            // Add keyboard shortcut hints
            const shortcutHint = document.createElement('div');
            shortcutHint.className = 'fixed bottom-4 left-4 bg-gray-800 text-white text-xs px-3 py-2 rounded-lg opacity-75 z-40';
            shortcutHint.innerHTML = `
                <div class="font-semibold mb-1">Keyboard Shortcuts:</div>
                <div>Ctrl+I: Income | Ctrl+E: Expense</div>
                <div>Ctrl+A: Asset | Ctrl+L: Liability</div>
                <div>Esc: Close form | Ctrl+Enter: Submit</div>
            `;
            
            // Show hint for 10 seconds on first visit
            if (!localStorage.getItem('shortcutsShown')) {
                document.body.appendChild(shortcutHint);
                setTimeout(() => {
                    if (shortcutHint.parentElement) {
                        shortcutHint.remove();
                    }
                }, 10000);
                localStorage.setItem('shortcutsShown', 'true');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            checkAchievements();
            setupFormInteractions();
            setupEnhancedFormInteractions();
            updateSettings();
            addFormHints();
            
            // Set default due date to 30 days from now
            const defaultDueDate = new Date();
            defaultDueDate.setDate(defaultDueDate.getDate() + 30);
            if (document.getElementById('loanDueDate')) {
                document.getElementById('loanDueDate').value = defaultDueDate.toISOString().split('T')[0];
            }
            
            // Check for notifications on load
            setTimeout(() => {
                checkDailyNotifications();
            }, 2000);
            
            // Check notifications daily
            setInterval(checkDailyNotifications, 24 * 60 * 60 * 1000); // Every 24 hours
            
            // Check notifications every hour for more frequent updates
            setInterval(checkDailyNotifications, 60 * 60 * 1000); // Every hour
            
            // Add install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });
        });

        // Show install button
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = 'üì± Install App';
            installBtn.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-700 transition-colors z-50';
            installBtn.onclick = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                        installBtn.remove();
                    });
                }
            };
            document.body.appendChild(installBtn);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installBtn.parentElement) {
                    installBtn.remove();
                }
            }, 10000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97aefb44e5fb913b',t:'MTc1NzE3MjM1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
